name: Update README for ghpages

# ワークフローの処理の流れ:
# 1. HTML/Covワークフローのいずれかが完了すると起動（計2回トリガー）
# 2. 先頭で両方のワークフロー(HTML/Cov)が成功しているか確認
# 3. 両方成功している場合のみREADME更新を実行
# 4. 実際にデプロイされたレポートのディレクトリ構造から動的にREADMEを生成
# 注: 1回目で更新、2回目は"No changes"でスキップされる

on:
  workflow_run:
    workflows:
      - "pytest-testmon Deploy Multi-OS"
    types:
      - completed
    branches:
      - main
      - test/pytest-testmon-workflow
  workflow_dispatch:  # 手動実行も可能

jobs:
  update-readme:
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout ghpages branch
        uses: actions/checkout@v5.0.0
        with:
          ref: ghpages
          fetch-depth: 0

      - name: Generate README
        run: |
          # 実際にデプロイされているレポートからPythonバージョンを取得
          # 数字で始まるバージョン番号のみを抽出（assets, pythonなどのディレクトリを除外）
          if [ -d "pytest-html-report" ]; then
            python_versions=$(find pytest-html-report -type d -path "*/python/*" -printf '%f\n' 2>/dev/null | \
              grep -E '^[0-9]+\.[0-9]+(\.[0-9]+)?$' | sort -V -u)
          else
            echo "⚠️ pytest-html-report directory not found"
            python_versions=""
          fi

          # 固定のOS順序
          os_order="ubuntu-latest macos-latest windows-latest"

          echo "Detected Python versions: ${python_versions}"
          echo "OS order: ${os_order}"

          # README.mdを生成
          {
            echo "# Pytest Report"
            echo ""
            echo "This repository deploys [pytest-html](https://pypi.org/project/pytest-html/) and [pytest-cov](https://pypi.org/project/pytest-cov/) reports to GitHub Pages."
            echo ""
            echo "## pytest-html"
            echo ""
            echo "[![pytest-html Report and Deploy Multi-OS](https://github.com/7rikazhexde/python-project-sandbox/actions/workflows/test_pytest-html-report_deploy_multi_os.yml/badge.svg)](https://github.com/7rikazhexde/python-project-sandbox/actions/workflows/test_pytest-html-report_deploy_multi_os.yml)"
            echo ""
            echo "| Python Version | ubuntu-latest | macos-latest | windows-latest |"
            echo "|----------------|---------------|----------|----------------|"
          } > README.md

          # Pythonバージョンごとに行を追加（実際に存在するレポートのみ）
          for version in ${python_versions}; do
            echo -n "| ${version} " >> README.md
            for os in ${os_order}; do
              if [ -f "pytest-html-report/${os}/python/${version}/report_page.html" ]; then
                echo -n "| [report-url](https://7rikazhexde.github.io/python-project-sandbox/pytest-html-report/${os}/python/${version}/report_page.html) " >> README.md
              else
                echo -n "| N/A " >> README.md
              fi
            done
            echo "|" >> README.md
          done

          # pytest-covセクションを追加
          {
            echo ""
            echo "## pytest-cov"
            echo ""
            echo "[![pytest-cov Report and Deploy Multi-OS](https://github.com/7rikazhexde/python-project-sandbox/actions/workflows/test_pytest-cov-report_deploy_multi_os.yml/badge.svg)](https://github.com/7rikazhexde/python-project-sandbox/actions/workflows/test_pytest-cov-report_deploy_multi_os.yml)"
            echo ""
            echo "| Python Version | ubuntu-latest | macos-latest | windows-latest |"
            echo "|----------------|---------------|----------|----------------|"
          } >> README.md

          # Pythonバージョンごとに行を追加（実際に存在するレポートのみ）
          for version in ${python_versions}; do
            echo -n "| ${version} " >> README.md
            for os in ${os_order}; do
              if [ -f "pytest-cov-report/${os}/python/${version}/index.html" ]; then
                echo -n "| [report-url](https://7rikazhexde.github.io/python-project-sandbox/pytest-cov-report/${os}/python/${version}/index.html) " >> README.md
              else
                echo -n "| N/A " >> README.md
              fi
            done
            echo "|" >> README.md
          done

          echo "" >> README.md

          echo "✅ README.md generated successfully"
          cat README.md

      - name: Commit and push
        run: |
          git config --local user.email "33836132+github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          if git diff --quiet README.md; then
            echo "No changes to README.md"
            exit 0
          fi

          git add README.md
          git commit -m "docs: Update README with latest report links" \
            -m "Generated from matrix.json configuration" \
            -m "Workflow run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

          # Push with retry
          max_retries=3
          retry_count=0
          while [ $retry_count -lt $max_retries ]; do
            if git push origin ghpages; then
              echo "✅ README.md updated successfully"
              break
            else
              retry_count=$((retry_count + 1))
              if [ $retry_count -lt $max_retries ]; then
                echo "Push failed, retrying ($retry_count/$max_retries)..."
                git pull origin ghpages --rebase
              else
                echo "❌ Push failed after $max_retries retries"
                exit 1
              fi
            fi
          done
