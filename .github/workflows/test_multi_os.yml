name: Test Multi-OS

on:
  push:
    branches:
      - 'main'
    paths:
      - 'project_a/**'
      - 'tests/**'
      - 'pyproject.toml'
      - 'uv.lock'          # poetry.lock â†’ uv.lock
      - 'justfile'         # justfile ã‚’è¿½åŠ 
  workflow_dispatch:

jobs:
  set_variables:
    if: ( !startsWith(github.event.head_commit.message, 'Bump version') && !startsWith(github.event.head_commit.message, '[skip ci]') )
    runs-on: ubuntu-latest
    outputs:
      os: ${{ steps.json2vars.outputs.os }}
      versions_python: ${{ steps.json2vars.outputs.versions_python }}
      ghpages_branch: ${{ steps.json2vars.outputs.ghpages_branch }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4.2.2
        with:
          fetch-depth: 0

      - name: Set variables from JSON
        id: json2vars
        uses: 7rikazhexde/json2vars-setter@main
        with:
          json-file: .github/json2vars-setter/matrix.json

      - name: Debug output values
        run: |
          echo "os: ${{ steps.json2vars.outputs.os }}"
          echo "versions_python: ${{ steps.json2vars.outputs.versions_python }}"
          echo "ghpages_branch: ${{ steps.json2vars.outputs.ghpages_branch }}"

  check_file:
    needs: set_variables
    runs-on: ubuntu-latest
    outputs:
      file_exists: ${{ steps.check_file.outputs.file_exists }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4.2.2

      - name: Check file existence
        id: check_file
        run: |
          if [ -f "project_a/staking/ton_whales_staking_dashboard.py" ]; then
            echo "file_exists=true" >> "$GITHUB_OUTPUT"
            echo "âœ… Found excluded file: project_a/staking/ton_whales_staking_dashboard.py"
          else
            echo "file_exists=false" >> "$GITHUB_OUTPUT"
            echo "â„¹ï¸ Excluded file not found: project_a/staking/ton_whales_staking_dashboard.py"
          fi

  test:
    needs: [set_variables, check_file]
    strategy:
      matrix:
        os: ${{ fromJson(needs.set_variables.outputs.os) }}
        python-version: ${{ fromJson(needs.set_variables.outputs.versions_python) }}
    runs-on: ${{ matrix.os }}
    env:
      TZ: 'Asia/Tokyo'
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4.2.2

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"
          enable-cache: true

      - name: Set up Python with uv
        run: |
          uv python install "${{ matrix.python-version }}"
          uv python pin "${{ matrix.python-version }}"

      - name: Set timezone
        uses: szenius/set-timezone@v2.0
        with:
          timezoneLinux: "Asia/Tokyo"
          timezoneMacos: "Asia/Tokyo"
          timezoneWindows: "Tokyo Standard Time"

      - name: Check timezone and Python version
        shell: bash
        run: |
          echo "System date: $(date)"
          echo "TZ environment variable: ${TZ}"
          uv run python -c "import datetime, platform, sys; print(f'Python version: {sys.version}'); print(f'Python timezone: {datetime.datetime.now().astimezone().tzinfo}'); print(f'OS: {platform.system()}')"

      - name: Install just task runner
        shell: bash
        env:
          RUNNER_OS: ${{ runner.os }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          case "${RUNNER_OS}" in
            "Linux")
              echo "ğŸ§ Installing just on Linux..."
              # GitHub Actionsã®ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ä½¿ç”¨ã—ã¦APIåˆ¶é™ã‚’å›é¿
              if [ -n "$GITHUB_TOKEN" ]; then
                echo "Using GitHub token for API access..."
                release_info=$(curl -H "Authorization: token $GITHUB_TOKEN" \
                  -H "Accept: application/vnd.github.v3+json" \
                  -s "https://api.github.com/repos/casey/just/releases/latest")
                download_url=$(echo "$release_info" | grep -o '"browser_download_url": "[^"]*x86_64-unknown-linux-musl.tar.gz"' | cut -d'"' -f4)
              else
                # ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: æœ€æ–°ã®å®‰å®šç‰ˆã‚’ç›´æ¥æŒ‡å®š
                echo "Using fallback download method..."
                download_url="https://github.com/casey/just/releases/download/1.34.0/just-1.34.0-x86_64-unknown-linux-musl.tar.gz"
              fi

              if [ -n "$download_url" ]; then
                echo "ğŸ“¥ Downloading just from: $download_url"
                mkdir -p "${HOME}/.local/bin"
                cd /tmp
                curl -L "$download_url" | tar xz
                mv just "${HOME}/.local/bin/"
                chmod +x "${HOME}/.local/bin/just"
                echo "${HOME}/.local/bin" >> "${GITHUB_PATH}"
                echo "âœ… just installed successfully"
              else
                echo "âŒ Failed to get download URL for just"
                exit 1
              fi
              ;;
            "macOS")
              echo "ğŸ Installing just on macOS..."
              brew install just
              ;;
            "Windows")
              echo "ğŸªŸ Installing just on Windows..."
              choco install just
              ;;
            *)
              echo "â“ Unknown OS: ${RUNNER_OS}"
              exit 1
              ;;
          esac

      - name: Verify installations
        shell: bash
        run: |
          echo "ğŸ”§ Tool versions:"
          uv --version

          # justã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç¢ºèªï¼ˆãƒ‘ã‚¹ãŒæ›´æ–°ã•ã‚Œã‚‹ã¾ã§å°‘ã—å¾…ã¤ï¼‰
          sleep 2
          if command -v just &> /dev/null; then
            just --version
            echo "âœ… just is available"
          else
            echo "âš ï¸ just not yet available in PATH, checking manually..."
            if [ -f "${HOME}/.local/bin/just" ]; then
              "${HOME}/.local/bin/just" --version
              echo "âœ… just found in ${HOME}/.local/bin"
            else
              echo "âŒ just installation failed"
              exit 1
            fi
          fi

          uv run python --version

          if [ -f "uv.lock" ]; then
            echo "ğŸ“¦ uv.lock hash: $(sha256sum uv.lock | cut -d' ' -f1 2>/dev/null || echo 'N/A')"
          else
            echo "ğŸ“¦ uv.lock: not found"
          fi

      - name: Cache uv dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/uv
            .venv
          key: uv-${{ runner.os }}-${{ matrix.python-version }}-${{ hashFiles('uv.lock') }}
          restore-keys: |
            uv-${{ runner.os }}-${{ matrix.python-version }}-
            uv-${{ runner.os }}-

      - name: Install dependencies
        shell: bash
        run: |
          echo "ğŸ“¥ Installing dependencies with uv..."
          uv sync --extra dev

          echo "ğŸ” Virtual environment info:"
          uv venv --show-path || echo "Using default .venv"

          echo "ğŸ“‹ Installed packages:"
          uv pip list | head -20
          echo "... (truncated)"

      - name: Run tests with coverage
        id: pytest
        shell: bash
        run: |
          echo "ğŸ§ª Running tests..."

          # justãŒåˆ©ç”¨å¯èƒ½ãªå ´åˆã¯justã‚’ä½¿ç”¨ã€ãã†ã§ãªã‘ã‚Œã°uv runã§ç›´æ¥å®Ÿè¡Œ
          if command -v just &> /dev/null || [ -f "${HOME}/.local/bin/just" ]; then
            echo "Using just for test execution..."

            # justã‚³ãƒãƒ³ãƒ‰ã®ãƒ‘ã‚¹ã‚’ç¢ºå®š
            if command -v just &> /dev/null; then
              JUST_CMD="just"
            else
              JUST_CMD="${HOME}/.local/bin/just"
            fi

            echo "ğŸ“‹ Available just tasks:"
            $JUST_CMD --list

            # CIç”¨ã®XMLãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆã‚¿ã‚¹ã‚¯ã‚’å®Ÿè¡Œ
            if $JUST_CMD --list | grep -q "test-ci-xml"; then
              echo "ğŸš€ Running: $JUST_CMD test-ci-xml"
              $JUST_CMD test-ci-xml
            elif $JUST_CMD --list | grep -q "testcixml"; then
              echo "ğŸš€ Running: $JUST_CMD testcixml"
              $JUST_CMD testcixml
            else
              echo "ğŸ“Š Running fallback pytest with coverage..."
              # ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: ç›´æ¥pytestå®Ÿè¡Œ
              uv run pytest --durations=0 --junitxml=pytest.xml --cov-report xml:coverage.xml --cov=project_a tests/ | tee pytest-coverage.txt
            fi
          else
            echo "Using uv run for test execution..."
            uv run pytest --durations=0 --junitxml=pytest.xml --cov-report xml:coverage.xml --cov=project_a tests/ | tee pytest-coverage.txt
          fi

          echo "âœ… Tests completed"

      - name: Generate coverage text report
        shell: bash
        run: |
          # PRç”¨ã®ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ†ã‚­ã‚¹ãƒˆãƒ¬ãƒãƒ¼ãƒˆãŒæœªç”Ÿæˆã®å ´åˆã¯ç”Ÿæˆ
          if [ ! -f "pytest-coverage.txt" ]; then
            echo "ğŸ“Š Generating coverage text report..."

            # justã‚³ãƒãƒ³ãƒ‰ã®ãƒ‘ã‚¹ã‚’ç¢ºå®š
            if command -v just &> /dev/null; then
              JUST_CMD="just"
            elif [ -f "${HOME}/.local/bin/just" ]; then
              JUST_CMD="${HOME}/.local/bin/just"
            else
              JUST_CMD=""
            fi

            if [ -n "$JUST_CMD" ] && $JUST_CMD --list | grep -q "testcov"; then
              $JUST_CMD testcov > pytest-coverage.txt
            else
              uv run pytest --cov=project_a --cov-branch --cov-report=term-missing tests/ > pytest-coverage.txt
            fi
          fi

      - name: Pytest coverage comment
        id: coverageComment
        uses: MishaKav/pytest-coverage-comment@v1.1.54
        with:
          pytest-coverage-path: ./pytest-coverage.txt
          pytest-xml-coverage-path: ./coverage.xml
          title: Multi-OS Coverage Report (${{ matrix.os }} / Python ${{ matrix.python-version }})
          badge-title: coverage
          hide-badge: false
          hide-report: false
          create-new-comment: false
          hide-comment: false
          report-only-changed-files: false
          remove-link-from-badge: false
          junitxml-path: ./pytest.xml
          junitxml-title: "Multi-OS Pytest Result Summary (os: ${{ matrix.os }} / python-version: ${{ matrix.python-version }})"
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Check test results
        if: steps.pytest.outcome == 'failure'
        run: |
          echo "::error::Tests failed on ${{ matrix.os }} with Python ${{ matrix.python-version }}"
          echo "::error::This will prevent merging the pull request."
          exit 1

      - name: Save summary report
        shell: bash
        run: |
          echo "ğŸ’¾ Saving summary report..."
          echo '${{ steps.coverageComment.outputs.summaryReport }}' > summary-report.md

          # ãƒ¬ãƒãƒ¼ãƒˆå†…å®¹ã®ç¢ºèª
          echo "ğŸ“„ Summary report preview:"
          head -5 summary-report.md

      - name: Upload coverage data
        uses: actions/upload-artifact@v4.6.1
        with:
          name: coverage-data-${{ matrix.os }}-${{ matrix.python-version }}
          path: |
            pytest-coverage.txt
            coverage.xml
            pytest.xml
            summary-report.md
          retention-days: 30

  update_readme:
    needs: [set_variables, check_file, test]
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4.2.2
        with:
          fetch-depth: 0

      - name: Download all artifacts
        uses: actions/download-artifact@v4.1.9

      - name: Update README in coverage branch
        shell: bash
        run: |
          echo "ğŸ”„ Updating README in coverage branch..."

          # GitHub Actionsã®å¤‰æ•°å½¢å¼ã§è¨­å®š
          os='${{ needs.set_variables.outputs.os }}'
          python_versions='${{ needs.set_variables.outputs.versions_python }}'

          # JSONå½¢å¼ã®æ–‡å­—åˆ—ã‹ã‚‰é…åˆ—ã‚’ä½œæˆ
          os_list=$(echo "${os}" | jq -r '.[]' | tr '\n' ' ' | sed 's/ $//')
          python_versions_list=$(echo "${python_versions}" | jq -r '.[]' | tr '\n' ' ' | sed 's/ $//')

          echo "ğŸ“‹ Testing matrix:"
          echo "  OS: ${os_list}"
          echo "  Python versions: ${python_versions_list}"

          # "coverage" ãƒ–ãƒ©ãƒ³ãƒãŒå­˜åœ¨ã™ã‚‹å ´åˆã¯ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆã€å­˜åœ¨ã—ãªã„å ´åˆã¯æ–°è¦ä½œæˆã™ã‚‹
          if git ls-remote --heads origin coverage | grep coverage; then
            echo "ğŸ“‚ Checking out existing coverage branch..."
            git checkout coverage
          else
            echo "ğŸ†• Creating new coverage branch..."
            git checkout --orphan coverage
            git rm -rf .
          fi

          # README.mdã®å†…å®¹ã‚’ä¸€åº¦ã«ç”Ÿæˆ
          {
            echo "# ğŸ§ª Pytest Coverage Summary"
            echo ""
            echo "[![Test Multi-OS](https://github.com/${GITHUB_REPOSITORY}/actions/workflows/test_multi_os.yml/badge.svg)](https://github.com/${GITHUB_REPOSITORY}/actions/workflows/test_multi_os.yml)"
            echo ""
            echo "## ğŸ“Š Latest Test Results"
            echo ""

            # æœ€æ–°ã®ã‚³ãƒŸãƒƒãƒˆæƒ…å ±ã‚’READMEã«è¿½åŠ 
            commit_hash8=${GITHUB_SHA::8}
            commit_link="[${commit_hash8}](https://github.com/${GITHUB_REPOSITORY}/tree/${commit_hash8})"
            echo -e "> [!Note]"
            echo -e "> **Latest Commit:** ${commit_link}"
            echo -e "> **Tool Stack:** uv + just"
            echo -e "> **Generated:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
            echo -e ""

            # ãƒ†ã‚¹ãƒˆå¯¾è±¡å¤–ã®ãƒ•ã‚¡ã‚¤ãƒ«ã«é–¢ã™ã‚‹æ³¨è¨˜ã‚’è¿½åŠ ï¼ˆãƒ•ã‚¡ã‚¤ãƒ«ã®å­˜åœ¨ç¢ºèªçµæœã«åŸºã¥ãï¼‰
            commit_hash=${GITHUB_SHA}
            file_path_1="project_a/staking/ton_whales_staking_dashboard.py"
            file_path_2="staking/ton_whales_staking_dashboard.py"
            file_link="https://github.com/${GITHUB_REPOSITORY}/blob/${commit_hash}/${file_path_2}"

            if [[ "${{ needs.check_file.outputs.file_exists }}" == "true" ]]; then
              echo -e "> [!Important]"
              echo -e "> **Excluded from Coverage:**"
              echo -e "> The following file is intentionally excluded from test coverage:"
              echo -e "> - [${file_path_1}](${file_link})"
              echo -e "> "
              echo -e "> This file contains complex external dependencies and is verified through manual and integration testing."
              echo -e "> "
            else
              echo "<!-- Note: File ${file_path_1} not found. Skipping addition to README.md. -->" >&2
            fi

            echo "## ğŸ” Coverage Reports by Environment"
            echo ""

            # macOSã€Ubuntuã€Windowsã®å„OSã¨Pythonãƒãƒ¼ã‚¸ãƒ§ãƒ³ã”ã¨ã«ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ¬ãƒãƒ¼ãƒˆã‚’è¿½åŠ 
            for os in ${os_list}; do
              for version in ${python_versions_list}; do
                # OSçµµæ–‡å­—ã®é¸æŠ
                case "${os}" in
                  "ubuntu-latest") os_emoji="ğŸ§" ;;
                  "macos-latest") os_emoji="ğŸ" ;;
                  "windows-latest") os_emoji="ğŸªŸ" ;;
                  *) os_emoji="ğŸ’»" ;;
                esac

                echo "### ${os_emoji} ${os} / Python ${version}"
                echo ""

                if [ -f "coverage-data-${os}-${version}/summary-report.md" ]; then
                  # HTMLã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã‚’ãƒ‡ã‚³ãƒ¼ãƒ‰ã—ã€ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—æ–‡å­—ã‚’å‡¦ç†
                  sed -e 's/^"//' -e 's/"$//' -e 's/\\"/"/g' -e 's/\\\\/\\/g' -e 's/\\n/\n/g' -e 's/\r$//' "coverage-data-${os}-${version}/summary-report.md" |
                  sed -e 's/&lt;/</g' -e 's/&gt;/>/g' -e 's/&amp;/\&/g' |
                  sed '/^$/N;/^\n$/D' |
                  sed -e 's/^"//' -e 's/"$//'
                else
                  echo "âš ï¸ No summary report found for ${os} - Python ${version}"
                fi
                echo ""
              done
            done

            echo "---"
            echo ""
            echo "**Generated by GitHub Actions** â€¢ [View Workflow](https://github.com/${GITHUB_REPOSITORY}/actions/workflows/test_multi_os.yml)"

          } > README.md

          # ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ¬ãƒãƒ¼ãƒˆå†…ã®ãƒªãƒ³ã‚¯ã‚’æœ‰åŠ¹ã«ã™ã‚‹ãŸã‚ã«ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ã‚’ä¿®æ­£ã™ã‚‹
          sed -i '
            s|/blob/undefined/\([^"]*\)|/blob/'"${commit_hash}"'/\1|g;
            s|/blob/\([a-f0-9]*\)/\([^"]*\)|/blob/\1/project_a/\2|g;
            s|/blob/\([a-f0-9]*\)/project_a/README\.md|/blob/\1/README.md|g
          ' README.md

          echo "âœ… README.md generated successfully"

      - name: Commit and push coverage branch
        shell: bash
        run: |
          echo "ğŸ“¤ Committing and pushing to coverage branch..."

          # Gitã®ãƒ¦ãƒ¼ã‚¶ãƒ¼è¨­å®šã¨ã‚³ãƒŸãƒƒãƒˆã€ãƒ–ãƒ©ãƒ³ãƒã¸ã®ãƒ—ãƒƒã‚·ãƒ¥
          git config --local user.email "33836132+github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          # å¤‰æ›´ãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
          if git diff --quiet README.md; then
            echo "â„¹ï¸ No changes to commit"
          else
            git add README.md
            git commit -m "ğŸ“Š Update coverage for all environments

            - Commit: ${GITHUB_SHA::8}
            - Tools: uv + just
            - Generated: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"

            git push origin coverage
            echo "âœ… Coverage branch updated successfully"
          fi

  check_all_tests:
    needs: [set_variables, check_file, test, update_readme]
    runs-on: ubuntu-latest
    steps:
      - name: Check test results
        if: contains(needs.test.result, 'failure')
        run: |
          echo "::error::Some tests failed across multiple environments."
          echo "::error::Failed test matrices: ${{ toJson(needs.test.result) }}"
          echo "::warning::Please check the test results and fix any issues before merging."
          exit 1

      - name: All tests passed
        if: success()
        run: |
          echo "ğŸ‰ All tests passed successfully across all OS and Python version combinations!"
          echo "âœ… Multi-OS testing completed with uv + just"
