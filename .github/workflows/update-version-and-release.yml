# =============================================================================
# Version Update and Release Workflow
# =============================================================================
# æ¦‚è¦: ãƒãƒ¼ã‚¸ãƒ§ãƒ³æ›´æ–°ã¨GitHubãƒªãƒªãƒ¼ã‚¹ã®è‡ªå‹•ä½œæˆ
# å‡¦ç†: pyproject.tomlãƒãƒ¼ã‚¸ãƒ§ãƒ³æ›´æ–°ã€ã‚¿ã‚°ä½œæˆã€ãƒã‚§ãƒ³ã‚¸ãƒ­ã‚°ç”Ÿæˆã€ãƒªãƒªãƒ¼ã‚¹ä½œæˆ
# è£œè¶³: æ‰‹å‹•å®Ÿè¡Œã®ã¿ã€patch/minor/majoré¸æŠå¯èƒ½
# =============================================================================

name: Version Update and Release

on:
  workflow_dispatch:
    inputs:
      update_type:
        description: 'Type of version update'
        required: true
        default: 'patch'
        type: choice
        options:
        - patch
        - minor
        - major

jobs:
  # ==========================================================================
  # ãƒãƒ¼ã‚¸ãƒ§ãƒ³æ›´æ–°ãƒ»ãƒªãƒªãƒ¼ã‚¹ã‚¸ãƒ§ãƒ–
  # ==========================================================================
  # æ¦‚è¦: ã‚»ãƒãƒ³ãƒ†ã‚£ãƒƒã‚¯ãƒãƒ¼ã‚¸ãƒ§ãƒ‹ãƒ³ã‚°ã«ã‚ˆã‚‹ãƒãƒ¼ã‚¸ãƒ§ãƒ³æ›´æ–°ã¨ãƒªãƒªãƒ¼ã‚¹
  # å‡¦ç†: ãƒãƒ¼ã‚¸ãƒ§ãƒ³è¨ˆç®—ã€pyproject.tomlæ›´æ–°ã€ã‚¿ã‚°ä½œæˆã€ãƒªãƒªãƒ¼ã‚¹ä½œæˆ
  # è£œè¶³: tomlkitã¨packagingãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ä½¿ç”¨ã—ãŸè‡ªå‹•ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç®¡ç†
  # ==========================================================================
  update-version-and-release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6.0.1
        with:
          fetch-depth: 0
          token: ${{ secrets.PAT_FOR_PUSHES }}

      # ======================================================================
      # uvã‚­ãƒ£ãƒƒã‚·ãƒ¥
      # ======================================================================
      # æ¦‚è¦: Pythonä¾å­˜é–¢ä¿‚ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥
      # å‡¦ç†: ~/.cache/uvã¨.venvã‚’ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã€ä¾å­˜é–¢ä¿‚ãƒ•ã‚¡ã‚¤ãƒ«ãƒãƒƒã‚·ãƒ¥ã§ã‚­ãƒ¼ç”Ÿæˆ
      # è£œè¶³: çµ±ä¸€ã‚­ãƒ£ãƒƒã‚·ãƒ¥æˆ¦ç•¥ã‚’ä½¿ç”¨
      # ======================================================================
      - name: Cache uv dependencies
        uses: actions/cache@v5.0.2
        with:
          path: |
            ~/.cache/uv
            .venv
          key: uv-unified-${{ hashFiles('**/pyproject.toml', '**/uv.lock') }}

      - name: Install uv
        uses: astral-sh/setup-uv@v7.2.0
        with:
          enable-cache: false

      - name: Set up Python with uv
        run: |
          # Python 3.12ã‚’ä½¿ç”¨ï¼ˆå…ƒã®è¨­å®šã«åˆã‚ã›ã¦ï¼‰
          uv python install 3.12
          uv python pin 3.12

      # ======================================================================
      # ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç®¡ç†ãƒ„ãƒ¼ãƒ«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      # ======================================================================
      # æ¦‚è¦: pyproject.tomlãƒãƒ¼ã‚¸ãƒ§ãƒ³ç®¡ç†ã«å¿…è¦ãªãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      # å‡¦ç†: tomlkitã€packagingãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®è¿½åŠ ã¨ä¾å­˜é–¢ä¿‚åŒæœŸ
      # è£œè¶³: ãƒãƒ¼ã‚¸ãƒ§ãƒ³è¨ˆç®—ã¨TOMLæ“ä½œã«ä½¿ç”¨
      # ======================================================================
      - name: Install version management tool
        run: |
          echo "ğŸ“¦ Installing version management dependencies..."
          # tomlkitã‚’ä½¿ç”¨ã—ã¦pyproject.tomlã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ç®¡ç†
          uv add --dev tomlkit
          uv sync --extra dev

      - name: Configure Git
        run: |
          echo "âš™ï¸ Configuring Git..."
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"

      # ======================================================================
      # ç¾åœ¨ãƒãƒ¼ã‚¸ãƒ§ãƒ³å–å¾—
      # ======================================================================
      # æ¦‚è¦: pyproject.tomlã‹ã‚‰ç¾åœ¨ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’å–å¾—
      # å‡¦ç†: tomlkitã§pyproject.tomlã‚’è§£æã€ãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±ã‚’æŠ½å‡º
      # è£œè¶³: æ¬¡ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³è¨ˆç®—ã®åŸºæº–ã¨ã—ã¦ä½¿ç”¨
      # ======================================================================
      - name: Get current version
        id: current_version
        run: |
          echo "ğŸ” Getting current version from pyproject.toml..."
          current_version=$(uv run python -c "
          import tomlkit
          with open('pyproject.toml', 'r') as f:
              data = tomlkit.load(f)
          print(data['project']['version'])
          ")
          echo "Current version: $current_version"
          echo "version=$current_version" >> "$GITHUB_OUTPUT"

      # ======================================================================
      # æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³è¨ˆç®—
      # ======================================================================
      # æ¦‚è¦: ã‚»ãƒãƒ³ãƒ†ã‚£ãƒƒã‚¯ãƒãƒ¼ã‚¸ãƒ§ãƒ‹ãƒ³ã‚°ã«ã‚ˆã‚‹æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³è¨ˆç®—
      # å‡¦ç†: ç¾åœ¨ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¨æ›´æ–°ã‚¿ã‚¤ãƒ—ã‹ã‚‰æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ç®—å‡º
      # è£œè¶³: packaging.versionã‚’ä½¿ç”¨ã—ãŸæ­£ç¢ºãªãƒãƒ¼ã‚¸ãƒ§ãƒ³ç®¡ç†
      # ======================================================================
      - name: Calculate new version
        id: new_version
        run: |
          echo "ğŸ”¢ Calculating new version..."
          new_version=$(uv run python -c "
          import tomlkit
          from packaging.version import Version

          # ç¾åœ¨ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’å–å¾—
          with open('pyproject.toml', 'r') as f:
              data = tomlkit.load(f)
          current = Version(data['project']['version'])

          # æ–°ã—ã„ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’è¨ˆç®—
          update_type = '${{ github.event.inputs.update_type }}'
          if update_type == 'major':
              new = Version(f'{current.major + 1}.0.0')
          elif update_type == 'minor':
              new = Version(f'{current.major}.{current.minor + 1}.0')
          else:  # patch
              new = Version(f'{current.major}.{current.minor}.{current.micro + 1}')

          print(str(new))
          ")
          echo "New version: $new_version"
          echo "version=$new_version" >> "$GITHUB_OUTPUT"

      # ======================================================================
      # pyproject.tomlãƒãƒ¼ã‚¸ãƒ§ãƒ³æ›´æ–°
      # ======================================================================
      # æ¦‚è¦: pyproject.tomlãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±æ›´æ–°
      # å‡¦ç†: tomlkitã§TOMLãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ“ä½œã€æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’è¨­å®š
      # è£œè¶³: TOMLå½¢å¼ã¨ã‚³ãƒ¡ãƒ³ãƒˆã‚’ä¿æŒã—ã¦æ›´æ–°
      # ======================================================================
      - name: Update version in pyproject.toml
        run: |
          echo "ğŸ“ Updating version in pyproject.toml..."
          uv run python -c "
          import tomlkit

          # pyproject.tomlã‚’èª­ã¿è¾¼ã¿
          with open('pyproject.toml', 'r') as f:
              data = tomlkit.load(f)

          # ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’æ›´æ–°
          data['project']['version'] = '${{ steps.new_version.outputs.version }}'

          # ãƒ•ã‚¡ã‚¤ãƒ«ã«æ›¸ãæˆ»ã—
          with open('pyproject.toml', 'w') as f:
              tomlkit.dump(data, f)

          print('âœ… Version updated in pyproject.toml')
          "

          echo "ğŸ” Verifying version update..."
          grep "version.*${{ steps.new_version.outputs.version }}" pyproject.toml || {
            echo "âŒ Version update verification failed"
            exit 1
          }
          echo "âœ… Version update verified"

      - name: Update uv.lock file
        run: |
          echo "ğŸ”„ Updating uv.lock file..."
          uv lock
          echo "âœ… uv.lock updated"

      # ======================================================================
      # å¤‰æ›´ã®ã‚³ãƒŸãƒƒãƒˆãƒ»ãƒ—ãƒƒã‚·ãƒ¥
      # ======================================================================
      # æ¦‚è¦: ãƒãƒ¼ã‚¸ãƒ§ãƒ³æ›´æ–°ã‚’Gitãƒªãƒã‚¸ãƒˆãƒªã«ã‚³ãƒŸãƒƒãƒˆãƒ»ãƒ—ãƒƒã‚·ãƒ¥
      # å‡¦ç†: pyproject.tomlã¨uv.lockã®å¤‰æ›´ã‚’ã‚³ãƒŸãƒƒãƒˆã€ãƒªãƒ¢ãƒ¼ãƒˆã«ãƒ—ãƒƒã‚·ãƒ¥
      # è£œè¶³: å¤‰æ›´ãŒãªã„å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—
      # ======================================================================
      - name: Commit and push changes
        run: |
          echo "ğŸ“¤ Committing and pushing changes..."

          # å¤‰æ›´ãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
          if git diff --quiet pyproject.toml uv.lock; then
            echo "â„¹ï¸ No changes to commit"
          else
            git add pyproject.toml uv.lock
            git commit -m "ğŸ”– Bump version to ${{ steps.new_version.outputs.version }}" || echo "No changes to commit"
            git push
            echo "âœ… Changes committed and pushed"
          fi

      # ======================================================================
      # ã‚¿ã‚°ä½œæˆãƒ»ãƒ—ãƒƒã‚·ãƒ¥
      # ======================================================================
      # æ¦‚è¦: æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®Gitã‚¿ã‚°ä½œæˆã¨ãƒ—ãƒƒã‚·ãƒ¥
      # å‡¦ç†: v{version}å½¢å¼ã®ã‚¿ã‚°ã‚’ä½œæˆã€ãƒªãƒ¢ãƒ¼ãƒˆã«ãƒ—ãƒƒã‚·ãƒ¥
      # è£œè¶³: ãƒªãƒªãƒ¼ã‚¹ä½œæˆã®å‰ææ¡ä»¶
      # ======================================================================
      - name: Create and push new tag
        run: |
          echo "ğŸ·ï¸ Creating and pushing tag..."
          git tag v${{ steps.new_version.outputs.version }}
          git push --tags
          echo "âœ… Tag v${{ steps.new_version.outputs.version }} created and pushed"

      # ======================================================================
      # ãƒã‚§ãƒ³ã‚¸ãƒ­ã‚°ç”Ÿæˆ
      # ======================================================================
      # æ¦‚è¦: å‰ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‹ã‚‰ç¾åœ¨ã¾ã§ã®å¤‰æ›´å±¥æ­´ç”Ÿæˆ
      # å‡¦ç†: git logã§ã‚³ãƒŸãƒƒãƒˆå±¥æ­´ã‚’å–å¾—ã€ãƒã‚§ãƒ³ã‚¸ãƒ­ã‚°å½¢å¼ã§æ•´å½¢
      # è£œè¶³: ãƒªãƒªãƒ¼ã‚¹ãƒãƒ¼ãƒˆã«ä½¿ç”¨
      # ======================================================================
      - name: Generate changelog
        id: changelog
        run: |
          echo "ğŸ“‹ Generating changelog..."

          # å‰ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‹ã‚‰ç¾åœ¨ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¾ã§ã®å¤‰æ›´ãƒ­ã‚°ã‚’ç”Ÿæˆ
          if git rev-parse "v${{ steps.current_version.outputs.version }}" >/dev/null 2>&1; then
            changelog=$(git log --pretty=format:"- %s" v${{ steps.current_version.outputs.version }}..HEAD)
          else
            # å‰ã®ã‚¿ã‚°ãŒå­˜åœ¨ã—ãªã„å ´åˆã¯æœ€åˆã®ã‚³ãƒŸãƒƒãƒˆã‹ã‚‰
            changelog=$(git log --pretty=format:"- %s")
          fi

          if [ -z "$changelog" ]; then
            changelog="- Initial release"
          fi

          echo "Generated changelog:"
          echo "$changelog"

          # GitHubã®å‡ºåŠ›å½¢å¼ã«è¨­å®š
          {
            echo "changelog<<EOF"
            echo "$changelog"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

      # ======================================================================
      # GitHubãƒªãƒªãƒ¼ã‚¹ä½œæˆ
      # ======================================================================
      # æ¦‚è¦: GitHubãƒªãƒªãƒ¼ã‚¹ã®è‡ªå‹•ä½œæˆ
      # å‡¦ç†: softprops/action-gh-releaseã§ãƒªãƒªãƒ¼ã‚¹ä½œæˆã€è©³ç´°æƒ…å ±ã‚’è¨­å®š
      # è£œè¶³: ã‚¿ã‚°ã€ãƒã‚§ãƒ³ã‚¸ãƒ­ã‚°ã€ãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±ã‚’å«ã‚€
      # ======================================================================
      - name: Create Release
        uses: softprops/action-gh-release@v2.5.0
        with:
          tag_name: v${{ steps.new_version.outputs.version }}
          name: python-project-sandbox v${{ steps.new_version.outputs.version }}
          body: |
            ## ğŸš€ Changes in this Release

            ### ğŸ“Š Version Information
            - **Previous Version:** ${{ steps.current_version.outputs.version }}
            - **New Version:** ${{ steps.new_version.outputs.version }}
            - **Update Type:** ${{ github.event.inputs.update_type }}
            - **Tool:** uv

            ### ğŸ“ Changelog
            ${{ steps.changelog.outputs.changelog }}

            ### ğŸ”— Links
            - [Full Changelog](${{ github.server_url }}/${{ github.repository }}/compare/v${{ steps.current_version.outputs.version }}..v${{ steps.new_version.outputs.version }})
            - [pyproject.toml](${{ github.server_url }}/${{ github.repository }}/blob/v${{ steps.new_version.outputs.version }}/pyproject.toml)

            ---

            **Generated by GitHub Actions with uv** ğŸ¤–
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.PAT_FOR_PUSHES }}

      # ======================================================================
      # ã‚µãƒãƒªãƒ¼ä½œæˆ
      # ======================================================================
      # æ¦‚è¦: ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å®Ÿè¡Œçµæœã®ã‚µãƒãƒªãƒ¼ç”Ÿæˆ
      # å‡¦ç†: ãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±ã€å®Ÿè¡Œã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã€ãƒªãƒ³ã‚¯ã‚’ã‚µãƒãƒªãƒ¼è¡¨ç¤º
      # è£œè¶³: GitHub Actionsã®ã‚µãƒãƒªãƒ¼æ©Ÿèƒ½ã‚’ä½¿ç”¨
      # ======================================================================
      - name: Create summary
        run: |
          {
            echo "## ğŸ‰ Version Update and Release Summary"
            echo ""
            echo "### ğŸ“Š Version Information"
            echo "- **Previous Version:** ${{ steps.current_version.outputs.version }}"
            echo "- **New Version:** ${{ steps.new_version.outputs.version }}"
            echo "- **Update Type:** ${{ github.event.inputs.update_type }}"
            echo "- **Tool:** uv"
            echo ""
            echo "### âœ… Completed Actions"
            echo "- ğŸ“ Updated pyproject.toml"
            echo "- ğŸ”„ Updated uv.lock"
            echo "- ğŸ“¤ Committed and pushed changes"
            echo "- ğŸ·ï¸ Created and pushed tag v${{ steps.new_version.outputs.version }}"
            echo "- ğŸš€ Created GitHub release"
            echo ""
            echo "### ğŸ”— Quick Links"
            echo "- [ğŸ“‹ Release](${{ github.server_url }}/${{ github.repository }}/releases/tag/v${{ steps.new_version.outputs.version }})"
            echo "- [ğŸ” Compare Changes](${{ github.server_url }}/${{ github.repository }}/compare/v${{ steps.current_version.outputs.version }}..v${{ steps.new_version.outputs.version }})"
          } >> "$GITHUB_STEP_SUMMARY"
