name: Version Update and Release

# Workflow Process Flow:
# 1. Trigger Conditions:
#    - Manual execution (workflow_dispatch)
# 2. Environment Setup (Ubuntu, Python, uv)
# 3. Retrieve the current version from pyproject.toml
# 4. Update to the new version (patch, minor, or major) using uv
# 5. Commit and push the changes
# 6. Create and push a new tag
# 7. Generate the changelog
# 8. Create a GitHub release

on:
  workflow_dispatch:
    inputs:
      update_type:
        description: 'Type of version update'
        required: true
        default: 'patch'
        type: choice
        options:
        - patch
        - minor
        - major

jobs:
  update-version-and-release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5.0.0
        with:
          fetch-depth: 0
          token: ${{ secrets.PAT_FOR_PUSHES }}

      - name: Install uv
        uses: astral-sh/setup-uv@v6
        with:
          version: "latest"
          enable-cache: true

      - name: Set up Python with uv
        run: |
          # Python 3.12ã‚’ä½¿ç”¨ï¼ˆå…ƒã®è¨­å®šã«åˆã‚ã›ã¦ï¼‰
          uv python install 3.12
          uv python pin 3.12

      - name: Install version management tool
        run: |
          echo "ğŸ“¦ Installing version management dependencies..."
          # tomlkitã‚’ä½¿ç”¨ã—ã¦pyproject.tomlã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ç®¡ç†
          uv add --dev tomlkit
          uv sync --extra dev

      - name: Configure Git
        run: |
          echo "âš™ï¸ Configuring Git..."
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"

      - name: Get current version
        id: current_version
        run: |
          echo "ğŸ” Getting current version from pyproject.toml..."
          current_version=$(uv run python -c "
          import tomlkit
          with open('pyproject.toml', 'r') as f:
              data = tomlkit.load(f)
          print(data['project']['version'])
          ")
          echo "Current version: $current_version"
          echo "version=$current_version" >> "$GITHUB_OUTPUT"

      - name: Calculate new version
        id: new_version
        run: |
          echo "ğŸ”¢ Calculating new version..."
          new_version=$(uv run python -c "
          import tomlkit
          from packaging.version import Version

          # ç¾åœ¨ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’å–å¾—
          with open('pyproject.toml', 'r') as f:
              data = tomlkit.load(f)
          current = Version(data['project']['version'])

          # æ–°ã—ã„ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’è¨ˆç®—
          update_type = '${{ github.event.inputs.update_type }}'
          if update_type == 'major':
              new = Version(f'{current.major + 1}.0.0')
          elif update_type == 'minor':
              new = Version(f'{current.major}.{current.minor + 1}.0')
          else:  # patch
              new = Version(f'{current.major}.{current.minor}.{current.micro + 1}')

          print(str(new))
          ")
          echo "New version: $new_version"
          echo "version=$new_version" >> "$GITHUB_OUTPUT"

      - name: Update version in pyproject.toml
        run: |
          echo "ğŸ“ Updating version in pyproject.toml..."
          uv run python -c "
          import tomlkit

          # pyproject.tomlã‚’èª­ã¿è¾¼ã¿
          with open('pyproject.toml', 'r') as f:
              data = tomlkit.load(f)

          # ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’æ›´æ–°
          data['project']['version'] = '${{ steps.new_version.outputs.version }}'

          # ãƒ•ã‚¡ã‚¤ãƒ«ã«æ›¸ãæˆ»ã—
          with open('pyproject.toml', 'w') as f:
              tomlkit.dump(data, f)

          print('âœ… Version updated in pyproject.toml')
          "

          echo "ğŸ” Verifying version update..."
          grep "version.*${{ steps.new_version.outputs.version }}" pyproject.toml || {
            echo "âŒ Version update verification failed"
            exit 1
          }
          echo "âœ… Version update verified"

      - name: Update uv.lock file
        run: |
          echo "ğŸ”„ Updating uv.lock file..."
          uv lock
          echo "âœ… uv.lock updated"

      - name: Commit and push changes
        run: |
          echo "ğŸ“¤ Committing and pushing changes..."

          # å¤‰æ›´ãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
          if git diff --quiet pyproject.toml uv.lock; then
            echo "â„¹ï¸ No changes to commit"
          else
            git add pyproject.toml uv.lock
            git commit -m "ğŸ”– Bump version to ${{ steps.new_version.outputs.version }}" || echo "No changes to commit"
            git push
            echo "âœ… Changes committed and pushed"
          fi

      - name: Create and push new tag
        run: |
          echo "ğŸ·ï¸ Creating and pushing tag..."
          git tag v${{ steps.new_version.outputs.version }}
          git push --tags
          echo "âœ… Tag v${{ steps.new_version.outputs.version }} created and pushed"

      - name: Generate changelog
        id: changelog
        run: |
          echo "ğŸ“‹ Generating changelog..."

          # å‰ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‹ã‚‰ç¾åœ¨ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¾ã§ã®å¤‰æ›´ãƒ­ã‚°ã‚’ç”Ÿæˆ
          if git rev-parse "v${{ steps.current_version.outputs.version }}" >/dev/null 2>&1; then
            changelog=$(git log --pretty=format:"- %s" v${{ steps.current_version.outputs.version }}..HEAD)
          else
            # å‰ã®ã‚¿ã‚°ãŒå­˜åœ¨ã—ãªã„å ´åˆã¯æœ€åˆã®ã‚³ãƒŸãƒƒãƒˆã‹ã‚‰
            changelog=$(git log --pretty=format:"- %s")
          fi

          if [ -z "$changelog" ]; then
            changelog="- Initial release"
          fi

          echo "Generated changelog:"
          echo "$changelog"

          # GitHubã®å‡ºåŠ›å½¢å¼ã«è¨­å®š
          {
            echo "changelog<<EOF"
            echo "$changelog"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

      - name: Create Release
        uses: softprops/action-gh-release@v2.3.2
        with:
          tag_name: v${{ steps.new_version.outputs.version }}
          name: python-project-sandbox v${{ steps.new_version.outputs.version }}
          body: |
            ## ğŸš€ Changes in this Release

            ### ğŸ“Š Version Information
            - **Previous Version:** ${{ steps.current_version.outputs.version }}
            - **New Version:** ${{ steps.new_version.outputs.version }}
            - **Update Type:** ${{ github.event.inputs.update_type }}
            - **Tool:** uv

            ### ğŸ“ Changelog
            ${{ steps.changelog.outputs.changelog }}

            ### ğŸ”— Links
            - [Full Changelog](${{ github.server_url }}/${{ github.repository }}/compare/v${{ steps.current_version.outputs.version }}..v${{ steps.new_version.outputs.version }})
            - [pyproject.toml](${{ github.server_url }}/${{ github.repository }}/blob/v${{ steps.new_version.outputs.version }}/pyproject.toml)

            ---

            **Generated by GitHub Actions with uv** ğŸ¤–
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.PAT_FOR_PUSHES }}

      - name: Create summary
        run: |
          {
            echo "## ğŸ‰ Version Update and Release Summary"
            echo ""
            echo "### ğŸ“Š Version Information"
            echo "- **Previous Version:** ${{ steps.current_version.outputs.version }}"
            echo "- **New Version:** ${{ steps.new_version.outputs.version }}"
            echo "- **Update Type:** ${{ github.event.inputs.update_type }}"
            echo "- **Tool:** uv"
            echo ""
            echo "### âœ… Completed Actions"
            echo "- ğŸ“ Updated pyproject.toml"
            echo "- ğŸ”„ Updated uv.lock"
            echo "- ğŸ“¤ Committed and pushed changes"
            echo "- ğŸ·ï¸ Created and pushed tag v${{ steps.new_version.outputs.version }}"
            echo "- ğŸš€ Created GitHub release"
            echo ""
            echo "### ğŸ”— Quick Links"
            echo "- [ğŸ“‹ Release](${{ github.server_url }}/${{ github.repository }}/releases/tag/v${{ steps.new_version.outputs.version }})"
            echo "- [ğŸ” Compare Changes](${{ github.server_url }}/${{ github.repository }}/compare/v${{ steps.current_version.outputs.version }}..v${{ steps.new_version.outputs.version }})"
          } >> "$GITHUB_STEP_SUMMARY"
