# =============================================================================
# Update pre-commit Hooks Workflow
# =============================================================================
# æ¦‚è¦: pre-commitãƒ•ãƒƒã‚¯ã®å®šæœŸè‡ªå‹•æ›´æ–°
# å‡¦ç†: ãƒ•ãƒƒã‚¯æ›´æ–°ã€ãƒ†ã‚¹ãƒˆå®Ÿè¡Œã€ã‚«ãƒãƒ¬ãƒƒã‚¸ç¢ºèªã€å¤‰æ›´ã‚³ãƒŸãƒƒãƒˆ
# è£œè¶³: æ¯Žé€±é‡‘æ›œæ—¥å®Ÿè¡Œã€æ‰‹å‹•å®Ÿè¡Œå¯èƒ½ã€ã‚«ãƒãƒ¬ãƒƒã‚¸90%ä»¥ä¸Šã§è‡ªå‹•ã‚³ãƒŸãƒƒãƒˆ
# =============================================================================

name: Update pre-commit Hooks

on:
  schedule:
    - cron: '0 0 * * 5'  # æ¯Žé€±é‡‘æ›œæ—¥ã®åˆå‰0æ™‚ï¼ˆUTCï¼‰
  workflow_dispatch:

jobs:
  # ==========================================================================
  # å¤‰æ•°è¨­å®šã‚¸ãƒ§ãƒ–
  # ==========================================================================
  # æ¦‚è¦: å®Ÿè¡Œç’°å¢ƒè¨­å®šã®èª­ã¿è¾¼ã¿
  # å‡¦ç†: ci_matrix.jsonã‹ã‚‰OSãƒ»Pythonç‰ˆè¨­å®šã‚’å–å¾—ã€æœ€åˆã®è¦ç´ ã‚’é¸æŠž
  # è£œè¶³: å˜ä¸€ç’°å¢ƒã§ã®å®Ÿè¡Œã€è¤‡æ•°ç’°å¢ƒã¯ä¸è¦
  # ==========================================================================
  set_variables:
    runs-on: ubuntu-latest
    outputs:
      os: ${{ steps.json2vars.outputs.os }}
      versions_python: ${{ steps.json2vars.outputs.versions_python }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5.0.0
        with:
          fetch-depth: 0

      - name: Set variables from JSON
        id: json2vars
        uses: 7rikazhexde/json2vars-setter@v1.0.2
        with:
          json-file: .github/json2vars-setter/ci_matrix.json

      - name: Debug output values
        run: |
          echo "os: ${{ steps.json2vars.outputs.os }}"
          echo "versions_python: ${{ steps.json2vars.outputs.versions_python }}"
          echo "Selected OS: ${{ fromJson(steps.json2vars.outputs.os)[0] }}"
          echo "Selected Python version: ${{ fromJson(steps.json2vars.outputs.versions_python)[0] }}"

  # ==========================================================================
  # pre-commitãƒ•ãƒƒã‚¯æ›´æ–°ã‚¸ãƒ§ãƒ–
  # ==========================================================================
  # æ¦‚è¦: pre-commitãƒ•ãƒƒã‚¯ã®è‡ªå‹•æ›´æ–°ã¨ãƒ†ã‚¹ãƒˆ
  # å‡¦ç†: ãƒ•ãƒƒã‚¯æ›´æ–°ã€ãƒ†ã‚¹ãƒˆå®Ÿè¡Œã€ã‚«ãƒãƒ¬ãƒƒã‚¸ç¢ºèªã€æ¡ä»¶ä»˜ãã‚³ãƒŸãƒƒãƒˆ
  # è£œè¶³: ã‚«ãƒãƒ¬ãƒƒã‚¸90%ä»¥ä¸Šã®å ´åˆã®ã¿è‡ªå‹•ã‚³ãƒŸãƒƒãƒˆ
  # ==========================================================================
  update:
    needs: set_variables
    runs-on: ${{ fromJson(needs.set_variables.outputs.os)[0] }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5.0.0
        with:
          fetch-depth: 0
          token: ${{ secrets.PAT_FOR_PUSHES }}

      # ======================================================================
      # uvã‚­ãƒ£ãƒƒã‚·ãƒ¥
      # ======================================================================
      # æ¦‚è¦: Pythonä¾å­˜é–¢ä¿‚ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥
      # å‡¦ç†: ~/.cache/uvã¨.venvã‚’ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã€ä¾å­˜é–¢ä¿‚ãƒ•ã‚¡ã‚¤ãƒ«ãƒãƒƒã‚·ãƒ¥ã§ã‚­ãƒ¼ç”Ÿæˆ
      # è£œè¶³: çµ±ä¸€ã‚­ãƒ£ãƒƒã‚·ãƒ¥æˆ¦ç•¥ã‚’ä½¿ç”¨
      # ======================================================================
      - name: Cache uv dependencies
        uses: actions/cache@v4.3.0
        with:
          path: |
            ~/.cache/uv
            .venv
          key: uv-unified-${{ hashFiles('**/pyproject.toml', '**/uv.lock') }}

      - name: Install uv
        uses: astral-sh/setup-uv@v7.1.1
        with:
          enable-cache: false

      - name: Set up Python with uv
        run: |
          python_version="${{ fromJson(needs.set_variables.outputs.versions_python)[0] }}"
          echo "ðŸ Setting up Python $python_version"
          uv python install "$python_version"
          uv python pin "$python_version"

      - name: Install dependencies
        run: |
          echo "ðŸ“¥ Installing dependencies with uv..."
          uv sync --extra dev

          echo "ðŸ” Installed packages:"
          uv pip list | grep -E "(pre-commit|ruff|mypy)" || echo "Key tools not found in list"

      # ======================================================================
      # Rustç’°å¢ƒã¨ã‚­ãƒ£ãƒƒã‚·ãƒ¥
      # ======================================================================
      # æ¦‚è¦: Rustãƒ„ãƒ¼ãƒ«ãƒã‚§ãƒ¼ãƒ³ã¨justã‚³ãƒžãƒ³ãƒ‰ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      # å‡¦ç†: Rustã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã€ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã€justãƒ“ãƒ«ãƒ‰
      # è£œè¶³: OSåˆ¥ã«ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã€cargo install ã®é«˜é€ŸåŒ–
      # ======================================================================
      - uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable

      - uses: Swatinem/rust-cache@v2.8.1

      - name: Install just
        run: cargo install just --locked
        shell: bash

      - name: Verify installations
        run: |
          echo "ðŸ”§ Tool versions:"
          uv --version
          just --version
          uv run python --version

      # ======================================================================
      # pre-commitãƒ•ãƒƒã‚¯æ›´æ–°
      # ======================================================================
      # æ¦‚è¦: pre-commitãƒ•ãƒƒã‚¯ã®è‡ªå‹•æ›´æ–°ã¨å¤‰æ›´æ¤œå‡º
      # å‡¦ç†: pre-commit autoupdateã§ãƒ•ãƒƒã‚¯æ›´æ–°ã€å¤‰æ›´æœ‰ç„¡ã‚’ç¢ºèª
      # è£œè¶³: å¤‰æ›´ãŒãªã„å ´åˆã¯å¾Œç¶šå‡¦ç†ã‚’ã‚¹ã‚­ãƒƒãƒ—
      # ======================================================================
      - name: Update pre-commit hooks
        id: update_hooks
        run: |
          echo "ðŸ”„ Updating pre-commit hooks..."

          # pre-commitè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®å­˜åœ¨ç¢ºèª
          if [ ! -f ".pre-commit-config.yaml" ]; then
            echo "âŒ .pre-commit-config.yaml not found"
            exit 1
          fi

          echo "ðŸ“‹ Current pre-commit configuration:"
          uv run pre-commit --version

          # pre-commit hooksæ›´æ–°å‰ã®çŠ¶æ…‹ã‚’è¨˜éŒ²
          echo "ðŸ” Before update:"
          grep -E "(rev:|  - repo:)" .pre-commit-config.yaml || echo "No repos found"

          # pre-commit hooksã®æ›´æ–°å®Ÿè¡Œ
          uv run pre-commit autoupdate

          # å¤‰æ›´ãŒã‚ã£ãŸã‹ãƒã‚§ãƒƒã‚¯
          if git diff --exit-code .pre-commit-config.yaml; then
            echo "has_updates=false" >> "$GITHUB_OUTPUT"
            echo "â„¹ï¸ No updates to pre-commit hooks. Exiting workflow."
            echo "update_summary=No updates available" >> "$GITHUB_OUTPUT"
          else
            echo "has_updates=true" >> "$GITHUB_OUTPUT"
            echo "âœ… Pre-commit hooks updated successfully!"

            # æ›´æ–°å†…å®¹ã®ã‚µãƒžãƒªãƒ¼ã‚’ç”Ÿæˆ
            echo "ðŸ“‹ After update:"
            grep -E "(rev:|  - repo:)" .pre-commit-config.yaml || echo "No repos found"

            # å¤‰æ›´ã®è©³ç´°ã‚’è¨˜éŒ²
            update_summary=$(git diff --no-index /dev/null .pre-commit-config.yaml | grep -c "^+" || echo "0")
            echo "update_summary=Updated hooks with $update_summary changes" >> "$GITHUB_OUTPUT"
          fi

      # ======================================================================
      # ãƒ†ã‚¹ãƒˆå®Ÿè¡Œã¨ã‚«ãƒãƒ¬ãƒƒã‚¸æ¸¬å®š
      # ======================================================================
      # æ¦‚è¦: pre-commitãƒ•ãƒƒã‚¯æ›´æ–°å¾Œã®ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
      # å‡¦ç†: justã¾ãŸã¯uvã§ãƒ†ã‚¹ãƒˆå®Ÿè¡Œã€ã‚«ãƒãƒ¬ãƒƒã‚¸æ¸¬å®š
      # è£œè¶³: ãƒ•ãƒƒã‚¯æ›´æ–°ãŒã‚ã‚‹å ´åˆã®ã¿å®Ÿè¡Œ
      # ======================================================================
      - name: Run tests with coverage
        id: pytest
        if: steps.update_hooks.outputs.has_updates == 'true'
        shell: bash
        run: |
          echo "ðŸ§ª Running tests to verify pre-commit hook updates..."

          # justãŒåˆ©ç”¨å¯èƒ½ãªå ´åˆã¯justã‚’ä½¿ç”¨ã€ãã†ã§ãªã‘ã‚Œã°uv runã§ç›´æŽ¥å®Ÿè¡Œ
          if command -v just &> /dev/null && just --list | grep -q "testcixml"; then
            echo "Using just for test execution..."
            just testcixml
          else
            echo "Using uv run for test execution..."
            uv run python -m pytest --durations=0 --junitxml=pytest.xml --cov-report xml:coverage.xml --cov=project_a tests/
          fi

          # ã‚«ãƒãƒ¬ãƒƒã‚¸ã®å–å¾—
          coverage_percentage=$(uv run coverage report | grep TOTAL | awk '{print $NF}' | sed 's/%//')
          echo "Current coverage: ${coverage_percentage}%"
          echo "COVERAGE=${coverage_percentage}" >> "$GITHUB_ENV"

      # ======================================================================
      # ã‚«ãƒãƒ¬ãƒƒã‚¸é–¾å€¤ãƒã‚§ãƒƒã‚¯ã¨ã‚³ãƒŸãƒƒãƒˆ
      # ======================================================================
      # æ¦‚è¦: ã‚«ãƒãƒ¬ãƒƒã‚¸90%é–¾å€¤ç¢ºèªã¨æ¡ä»¶ä»˜ãè‡ªå‹•ã‚³ãƒŸãƒƒãƒˆ
      # å‡¦ç†: ã‚«ãƒãƒ¬ãƒƒã‚¸çŽ‡ç¢ºèªã€90%ä»¥ä¸Šã®å ´åˆã®ã¿å¤‰æ›´ã‚’ã‚³ãƒŸãƒƒãƒˆãƒ»ãƒ—ãƒƒã‚·ãƒ¥
      # è£œè¶³: ã‚«ãƒãƒ¬ãƒƒã‚¸ä¸è¶³ã®å ´åˆã¯ã‚³ãƒŸãƒƒãƒˆã‚’ã‚¹ã‚­ãƒƒãƒ—
      # ======================================================================
      - name: Commit changes if coverage is above 90%
        if: steps.update_hooks.outputs.has_updates == 'true'
        shell: bash
        run: |
          echo "ðŸ“Š Checking coverage threshold..."

          if [[ ! "$COVERAGE" =~ ^[0-9]+$ ]]; then
            echo "âŒ Error: Invalid coverage value: ${COVERAGE}"
            echo "::error::Coverage check failed due to invalid coverage value"
            exit 1
          elif [ "$COVERAGE" -lt 90 ]; then
            echo "âš ï¸ Test coverage is below 90%. Current coverage: ${COVERAGE}%"
            echo "::warning::Pre-commit hook update caused coverage to drop below 90%"
            echo "::notice::Skipping commit due to insufficient coverage"
          else
            echo "âœ… Test coverage is above or equal to 90%. Current coverage: ${COVERAGE}%"
            echo "ðŸ’¾ Committing pre-commit hook updates..."

            git config --local user.email "33836132+github-actions[bot]@users.noreply.github.com"
            git config --local user.name "github-actions[bot]"

            # ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«æ›´æ–°æƒ…å ±ã‚’å«ã‚ã‚‹
            commit_message="â¬†ï¸ Update pre-commit hooks [skip ci]

            ðŸ“‹ Summary: ${{ steps.update_hooks.outputs.update_summary }}
            ðŸ§ª Coverage: ${COVERAGE}%
            ðŸ”§ Tool: uv + just
            ðŸ“… Updated: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"

            git add .pre-commit-config.yaml
            git commit -m "$commit_message" || echo "No changes to commit"
            git push

            echo "ðŸŽ‰ Pre-commit hooks updated and committed successfully!"
          fi

      # ======================================================================
      # æ›´æ–°å¾Œãƒ•ãƒƒã‚¯ãƒ†ã‚¹ãƒˆ
      # ======================================================================
      # æ¦‚è¦: æ›´æ–°ã•ã‚ŒãŸpre-commitãƒ•ãƒƒã‚¯ã®å‹•ä½œç¢ºèª
      # å‡¦ç†: pre-commit run --all-filesã§å…¨ãƒ•ã‚¡ã‚¤ãƒ«ã«å¯¾ã—ã¦ãƒ•ãƒƒã‚¯å®Ÿè¡Œ
      # è£œè¶³: å¤±æ•—ã—ã¦ã‚‚ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã¯ç¶™ç¶š
      # ======================================================================
      - name: Run updated pre-commit hooks
        if: steps.update_hooks.outputs.has_updates == 'true'
        continue-on-error: true
        run: |
          echo "ðŸ” Testing updated pre-commit hooks..."
          uv run pre-commit run --all-files || echo "Some pre-commit checks failed, but continuing workflow"

      # ======================================================================
      # ã‚µãƒžãƒªãƒ¼ä½œæˆ
      # ======================================================================
      # æ¦‚è¦: ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å®Ÿè¡Œçµæžœã®ã‚µãƒžãƒªãƒ¼ç”Ÿæˆ
      # å‡¦ç†: æ›´æ–°çŠ¶æ³ã€ã‚«ãƒãƒ¬ãƒƒã‚¸æƒ…å ±ã€ã‚³ãƒŸãƒƒãƒˆçŠ¶æ³ã‚’ã‚µãƒžãƒªãƒ¼è¡¨ç¤º
      # è£œè¶³: GitHub Actionsã®ã‚µãƒžãƒªãƒ¼æ©Ÿèƒ½ã‚’ä½¿ç”¨
      # ======================================================================
      - name: Create summary
        if: always()
        run: |
          {
            echo "## ðŸ”„ Pre-commit Hooks Update Summary"
            echo ""
            echo "### ðŸ“Š Update Information"
            echo "- **OS:** ${{ fromJson(needs.set_variables.outputs.os)[0] }}"
            echo "- **Python Version:** ${{ fromJson(needs.set_variables.outputs.versions_python)[0] }}"
            echo "- **Tool:** uv + just"
            echo "- **Has Updates:** ${{ steps.update_hooks.outputs.has_updates }}"
            echo ""

            if [ "${{ steps.update_hooks.outputs.has_updates }}" == "true" ]; then
              echo "### âœ… Update Results"
              echo "- **Status:** Updates found and processed"
              echo "- **Summary:** ${{ steps.update_hooks.outputs.update_summary }}"
              if [ -n "$COVERAGE" ]; then
                echo "- **Coverage:** ${COVERAGE}%"
                if [ "$COVERAGE" -ge 90 ]; then
                  echo "- **Commit Status:** âœ… Committed and pushed"
                else
                  echo "- **Commit Status:** âš ï¸ Skipped due to low coverage"
                fi
              fi
            else
              echo "### â„¹ï¸ No Updates"
              echo "- **Status:** All pre-commit hooks are already up to date"
              echo "- **Action:** No changes required"
            fi

            echo ""
            echo "**Next scheduled run:** Every Friday at 00:00 UTC"
          } >> "$GITHUB_STEP_SUMMARY"
