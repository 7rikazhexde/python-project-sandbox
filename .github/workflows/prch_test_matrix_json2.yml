name: Test on PR by matrix.json (Except Dependabot)

on:
  pull_request:
    branches: "main"

jobs:
  generate_matrix:
    if: github.actor != 'dependabot[bot]' && !startsWith(github.event.pull_request.title, 'Bump version')
    runs-on: ubuntu-latest
    outputs:
      os: ${{ steps.set-matrix.outputs.os }}
      python_versions: ${{ steps.set-matrix.outputs.python_versions }}
      ghpages_branch: ${{ steps.set-matrix.outputs.ghpages_branch }}
      custom_param: ${{ steps.set-matrix.outputs.CUSTOM_CUSTOM_PARAM }}
      custom_param_list: ${{ steps.set-matrix.outputs.CUSTOM_CUSTOM_PARAM_LIST }}
      complex_list: ${{ steps.set-matrix.outputs.COMPLEX_LIST }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4.2.1
        with:
          fetch-depth: 0
      - name: Set up Python
        uses: actions/setup-python@v5.2.0
        with:
          python-version: '3.12'
      - name: Parse JSON and set outputs
        id: set-matrix
        run: |
          python3 .github/workflows/scripts/json_to_github_output.py .github/workflows/matrix.json
      - name: Debug output values
        run: |
          echo "OS: ${{ steps.set-matrix.outputs.os }}"
          echo "Python Versions: ${{ steps.set-matrix.outputs.python_versions }}"
          echo "GH Pages Branch: ${{ steps.set-matrix.outputs.ghpages_branch }}"
          echo "Custom Param: ${{ steps.set-matrix.outputs.CUSTOM_CUSTOM_PARAM }}"
          echo "Custom Param List: ${{ steps.set-matrix.outputs.CUSTOM_CUSTOM_PARAM_LIST }}"
          echo "Complex List: ${{ steps.set-matrix.outputs.COMPLEX_LIST }}"

  get_json_value:
    needs: generate_matrix
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4.2.1
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5.2.0
        with:
          python-version: '3.12'

      - name: Get JSON Value
        id: get_json_val
        run: |
          python3 .github/workflows/scripts/get_json_val.py "['COMPLEX_LIST'][0]['name']" "['COMPLEX_LIST'][1]['status']"
        env:
          COMPLEX_LIST: '${{ needs.generate_matrix.outputs.complex_list }}'

      - name: Debug JSON Value
        run: |
          echo "Complex List Name: ${{ env.VALUE_COMPLEX_LIST_0_NAME }}"
          echo "Complex List Status: ${{ env.VALUE_COMPLEX_LIST_1_STATUS }}"

      - name: Get JSON VALue
        id: get_json_val_raw
        shell: bash
        run: |
          ghpages_branch=${{ needs.generate_matrix.outputs.ghpages_branch }}
          custom_param=${{ needs.generate_matrix.outputs.custom_param }}
          # リストの場合は明示的に""で囲んで文字列化する。
          custom_param_list="${{ needs.generate_matrix.outputs.custom_param_list }}"
          complex_list="${{ needs.generate_matrix.outputs.complex_list }}"

          # custom_param_listが正しい形式か確認
          echo "Raw custom_param_list: $custom_param_list"
          echo "Raw complex_list: $complex_list"

          # Bashでリストの括弧やダブルクォートを削除
          #custom_param_list=$(echo $custom_param_list | sed 's/[][]//g' | tr -d '"')

          # リストを配列に変換
          custom_param_array=($custom_param_list)

          echo "GH Pages branch: $ghpages_branch"
          echo "Custom Param: $custom_param"
          echo "Custom Param List First Element: ${custom_param_array[0]}"
          echo "Custom Param List Second Element: ${custom_param_array[1]}"

      #- name: Run pytest
      #  id: pytest
      #  shell: bash
      #  run: |
      #    ghpages_branch=${{ needs.generate_matrix.outputs.ghpages_branch }}
      #    custom_param=${{ needs.generate_matrix.outputs.custom_param }}
      #    # リストの場合は明示的に""で囲んで文字列化する。
      #    custom_param_list="${{ needs.generate_matrix.outputs.custom_param_list }}"
      #    complex_list="${{ needs.generate_matrix.outputs.complex_list }}"

      #    # custom_param_listが正しい形式か確認
      #    echo "Raw custom_param_list: $custom_param_list"
      #    echo "Raw complex_list: $complex_list"

      #    # Bashでリストの括弧やダブルクォートを削除
      #    #custom_param_list=$(echo $custom_param_list | sed 's/[][]//g' | tr -d '"')

      #    # リストを配列に変換
      #    custom_param_array=($custom_param_list)

      #    echo "GH Pages branch: $ghpages_branch"
      #    echo "Custom Param: $custom_param"
      #    echo "Custom Param List First Element: ${custom_param_array[0]}"
      #    echo "Custom Param List Second Element: ${custom_param_array[1]}"

      #    output=$(poetry run pytest)
      #    echo "$output"
#
