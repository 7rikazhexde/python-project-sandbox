name: Dependabot PR Check

# „ÉØ„Éº„ÇØ„Éï„É≠„Éº„ÅÆÂá¶ÁêÜ„ÅÆÊµÅ„Çå:
# 1. „Éà„É™„Ç¨„ÉºÊù°‰ª∂:
#    - main„Éñ„É©„É≥„ÉÅ„Å∏„ÅÆ„Éó„É´„É™„ÇØ„Ç®„Çπ„ÉàÊôÇ
#    - Dependabot„Å´„Çà„ÇãÂÆüË°å„Åß„ÅÇ„Çã„Åì„Å®
#    - „Ç≥„Éü„ÉÉ„Éà„É°„ÉÉ„Çª„Éº„Ç∏„Åå"Bump version"„ÅßÂßã„Åæ„Å£„Å¶„ÅÑ„Å™„ÅÑ„Åì„Å®
# 2. „Ç∏„Éß„Éñ„ÅÆÊù°‰ª∂Âà§ÂÆö: Dependabot „Å´„Çà„ÇãPR„Åß„ÅÇ„Çã„Åì„Å®„Çí„ÉÅ„Çß„ÉÉ„ÇØ
# 3. OSÊØé„ÅÆÁí∞Â¢ÉË®≠ÂÆö (macos-latest, ubuntu-latest, windows-latest)
# 4. PythonÁí∞Â¢É„ÅÆ„Çª„ÉÉ„Éà„Ç¢„ÉÉ„Éó (3.11, 3.12, 3.13)
# 5. „Çø„Ç§„É†„Çæ„Éº„É≥„ÅÆË®≠ÂÆö (Asia/Tokyo)
# 6. „É™„Éù„Ç∏„Éà„É™„ÅÆ„ÉÅ„Çß„ÉÉ„ÇØ„Ç¢„Ç¶„Éà
# 7. uv „ÅÆ„Ç§„É≥„Çπ„Éà„Éº„É´
# 8. Python „Éê„Éº„Ç∏„Éß„É≥„ÅÆ„Ç§„É≥„Çπ„Éà„Éº„É´ (uvÁÆ°ÁêÜ)
# 9. uv.lock „Éï„Ç°„Ç§„É´„ÅÆËá™ÂãïÊõ¥Êñ∞ (Dependabot PRÊôÇ)
# 10. ‰æùÂ≠òÈñ¢‰øÇ„ÅÆ„Ç≠„É£„ÉÉ„Ç∑„É• (uv.lock)
# 11. „Éó„É≠„Ç∏„Çß„ÇØ„Éà‰æùÂ≠òÈñ¢‰øÇ„ÅÆ„Ç§„É≥„Çπ„Éà„Éº„É´ (uv sync)
# 12. „ÉÜ„Çπ„Éà„ÅÆÂÆüË°å„Å®„Ç´„Éê„É¨„ÉÉ„Ç∏„ÅÆË®àÁÆó (justÁµåÁî±)
# 13. „Ç´„Éê„É¨„ÉÉ„Ç∏„Åå90%‰ª•‰∏ä„Åß„ÅÇ„Çã„Åì„Å®„ÅÆ„ÉÅ„Çß„ÉÉ„ÇØ
# 14. „ÉÜ„Çπ„ÉàÁµêÊûú„Å®„Ç´„Éê„É¨„ÉÉ„Ç∏„É¨„Éù„Éº„Éà„ÅÆÁîüÊàê
# 15. „ÉÜ„Çπ„ÉàÁµêÊûú„ÅÆÁ¢∫Ë™ç„Å®Ë≠¶Âëä„ÅÆË°®Á§∫
# 16. „Ç∏„Éß„Éñ„Çµ„Éû„É™„Éº„ÅÆ‰ΩúÊàê
# 17. ÂÖ®„ÉÜ„Çπ„Éà„ÅÆÁµêÊûúÁ¢∫Ë™ç
# 18. Discord Webhook„ÅÆÈÄÅ‰ø°

on:
  pull_request:
    branches:
      - main

jobs:
  set_variables:
    if: github.actor == 'dependabot[bot]' && !startsWith(github.event.pull_request.title, 'Bump version')
    runs-on: ubuntu-latest
    outputs:
      os: ${{ steps.json2vars.outputs.os }}
      versions_python: ${{ steps.json2vars.outputs.versions_python }}
      ghpages_branch: ${{ steps.json2vars.outputs.ghpages_branch }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4.2.2
        with:
          fetch-depth: 0

      - name: Set variables from JSON
        id: json2vars
        uses: 7rikazhexde/json2vars-setter@v1.0.1
        #with:
        #  json-file: .github/workflows/matrix.json

      - name: Debug output values
        run: |
          echo "os: ${{ steps.json2vars.outputs.os }}"
          echo "versions_python: ${{ steps.json2vars.outputs.versions_python }}"
          echo "ghpages_branch: ${{ steps.json2vars.outputs.ghpages_branch }}"

  test:
    needs: set_variables
    strategy:
      matrix:
        os: ${{ fromJson(needs.set_variables.outputs.os) }}
        python-version: ${{ fromJson(needs.set_variables.outputs.versions_python) }}
    runs-on: ${{ matrix.os }}
    env:
      TZ: 'Asia/Tokyo'
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4.2.2
        with:
          # Dependabot„ÅÆÂ§âÊõ¥„Çí„Ç≥„Éü„ÉÉ„Éà„Åô„Çã„Åü„ÇÅ„ÄÅtoken„ÇíË®≠ÂÆö
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"
          enable-cache: true

      - name: Set up Python with uv
        shell: bash
        run: |
          echo "üêç Setting up Python ${{ matrix.python-version }} for Dependabot..."

          # Python „ÅÆ„Éê„Éº„Ç∏„Éß„É≥„ÇíÊ≠£Ë¶èÂåñÔºàWindowsÂØæÂøúÔºâ
          python_version="${{ matrix.python-version }}"

          # Python „Çí„Ç§„É≥„Çπ„Éà„Éº„É´
          uv python install "$python_version"
          uv python pin "$python_version"

          # Python „ÅÆÁ¢∫Ë™ç
          uv run python --version

          echo "‚úÖ Python setup completed"

      - name: Set timezone
        uses: szenius/set-timezone@v2.0
        with:
          timezoneLinux: "Asia/Tokyo"
          timezoneMacos: "Asia/Tokyo"
          timezoneWindows: "Tokyo Standard Time"

      - name: Check timezone and Python version
        shell: bash
        run: |
          echo "üåè System information:"
          echo "System date: $(date)"
          echo "TZ environment variable: ${TZ}"
          uv run python -c "import datetime, platform, sys; print(f'Python version: {sys.version}'); print(f'Python timezone: {datetime.datetime.now().astimezone().tzinfo}'); print(f'OS: {platform.system()}')"

      - name: Install just task runner
        shell: bash
        env:
          RUNNER_OS: ${{ runner.os }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          case "${RUNNER_OS}" in
            "Linux")
              echo "üêß Installing just on Linux..."
              if [ -n "$GITHUB_TOKEN" ]; then
                release_info=$(curl -H "Authorization: token $GITHUB_TOKEN" \
                  -H "Accept: application/vnd.github.v3+json" \
                  -s "https://api.github.com/repos/casey/just/releases/latest")
                download_url=$(echo "$release_info" | grep -o '"browser_download_url": "[^"]*x86_64-unknown-linux-musl.tar.gz"' | cut -d'"' -f4)
              else
                download_url="https://github.com/casey/just/releases/download/1.34.0/just-1.34.0-x86_64-unknown-linux-musl.tar.gz"
              fi

              if [ -n "$download_url" ]; then
                mkdir -p "${HOME}/.local/bin"
                cd /tmp
                curl -L "$download_url" | tar xz
                mv just "${HOME}/.local/bin/"
                chmod +x "${HOME}/.local/bin/just"
                echo "${HOME}/.local/bin" >> "${GITHUB_PATH}"
              fi
              ;;
            "macOS")
              echo "üçé Installing just on macOS..."
              brew install just
              ;;
            "Windows")
              echo "ü™ü Installing just on Windows..."
              choco install just
              ;;
          esac

      - name: Verify installations
        shell: bash
        run: |
          echo "üîß Tool versions:"
          uv --version

          # just„ÅÆ„Éê„Éº„Ç∏„Éß„É≥Á¢∫Ë™ç
          sleep 2
          if command -v just &> /dev/null; then
            just --version
          elif [ -f "${HOME}/.local/bin/just" ]; then
            "${HOME}/.local/bin/just" --version
          else
            echo "‚ö†Ô∏è just not available"
          fi

          uv run python --version

          if [ -f "uv.lock" ]; then
            echo "üì¶ uv.lock hash: $(sha256sum uv.lock | cut -d' ' -f1 2>/dev/null || echo 'N/A')"
          else
            echo "üì¶ uv.lock: not found"
          fi

      # Dependabot„ÅÆPR„Åßuv.lock„Éï„Ç°„Ç§„É´„ÇíÊõ¥Êñ∞
      - name: Update uv.lock for Dependabot PR
        if: matrix.os == 'ubuntu-latest' && matrix.python-version == '3.11'
        shell: bash
        run: |
          echo "üîÑ Updating uv.lock file for Dependabot PR..."

          # uv.lock„Éï„Ç°„Ç§„É´„ÅÆÁä∂ÊÖãÁ¢∫Ë™ç
          echo "Current uv.lock hash:"
          sha256sum uv.lock || echo "uv.lock not found"

          # ‰æùÂ≠òÈñ¢‰øÇ„ÅÆÂêåÊúüÔºàuv.lock„ÅÆÊõ¥Êñ∞Ôºâ
          uv sync --extra dev

          # Êõ¥Êñ∞Âæå„ÅÆuv.lock„Éï„Ç°„Ç§„É´„ÅÆÁ¢∫Ë™ç
          echo "Updated uv.lock hash:"
          sha256sum uv.lock

          # Â§âÊõ¥„Åå„ÅÇ„Çã„Åã„ÉÅ„Çß„ÉÉ„ÇØ
          if git diff --quiet uv.lock; then
            echo "‚úÖ uv.lock is already up to date"
          else
            echo "üìù uv.lock has been updated"
            git config --local user.email "action@github.com"
            git config --local user.name "GitHub Action"
            git add uv.lock
            git commit -m "Update uv.lock after dependency changes" || echo "No changes to commit"
          fi

      - name: Cache uv dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/uv
            .venv
          key: uv-${{ runner.os }}-${{ matrix.python-version }}-${{ hashFiles('uv.lock') }}
          restore-keys: |
            uv-${{ runner.os }}-${{ matrix.python-version }}-
            uv-${{ runner.os }}-

      - name: Install dependencies
        shell: bash
        run: |
          echo "üì• Installing dependencies with uv..."

          # ÈñãÁô∫‰æùÂ≠òÈñ¢‰øÇ„ÇÇÂê´„ÇÅ„Å¶„Ç§„É≥„Çπ„Éà„Éº„É´
          uv sync --extra dev

          # ‰ªÆÊÉ≥Áí∞Â¢É„ÅÆÁ¢∫Ë™ç
          echo "üîç Virtual environment info:"
          uv venv --show-path || echo "Using default .venv"

          # „Ç§„É≥„Çπ„Éà„Éº„É´Ê∏à„Åø„Éë„ÉÉ„Ç±„Éº„Ç∏„ÅÆÁ¢∫Ë™çÔºàDependabot„Å´„Çà„ÇãÊõ¥Êñ∞„ÇíÁ¢∫Ë™çÔºâ
          echo "üìã Installed packages:"
          uv pip list | head -20
          echo "... (showing first 20 packages)"

          # ‰æùÂ≠òÈñ¢‰øÇ„ÉÑ„É™„Éº„ÅÆË°®Á§∫ÔºàÊõ¥Êñ∞„Åï„Çå„Åü„Éë„ÉÉ„Ç±„Éº„Ç∏„ÅÆÁ¢∫Ë™çÔºâ
          echo "üå≥ Dependency tree:"
          uv tree | head -20 || echo "uv tree not available or too large"

      - name: Run tests with coverage
        id: pytest
        shell: bash
        run: |
          echo "üß™ Running tests to verify Dependabot dependency updates..."

          # just„Ç≥„Éû„É≥„Éâ„ÅÆ„Éë„Çπ„ÇíÁ¢∫ÂÆö
          if command -v just &> /dev/null; then
            JUST_CMD="just"
          elif [ -f "${HOME}/.local/bin/just" ]; then
            JUST_CMD="${HOME}/.local/bin/just"
          else
            JUST_CMD=""
          fi

          # „ÉÜ„Çπ„Éà„ÅÆÂÆüË°å
          if [ -n "$JUST_CMD" ] && $JUST_CMD --list | grep -q "testcov"; then
            echo "üöÄ Using just for test execution..."
            $JUST_CMD testcov
          else
            echo "üìä Using uv run for test execution..."
            uv run pytest --cov=project_a --cov-branch --cov-report=term-missing --cov-report=html --cov-report=xml project_a tests/
          fi

          # ÂøÖË¶Å„Å™„É¨„Éù„Éº„Éà„Éï„Ç°„Ç§„É´„ÅÆÁîüÊàê„ÇíÁ¢∫Ë™ç„ÉªË£úÂÆå
          if [ ! -f "coverage.xml" ]; then
            echo "üìÑ Generating missing coverage.xml..."
            uv run coverage xml
          fi

          if [ ! -f "pytest.xml" ]; then
            echo "üìÑ Generating missing pytest.xml..."
            uv run pytest --junitxml=pytest.xml project_a tests/ --tb=no -q
          fi

          # „Ç´„Éê„É¨„ÉÉ„Ç∏„ÅÆÂèñÂæó
          coverage_percentage=$(uv run coverage report | grep "TOTAL" | awk '{print $NF}' | sed 's/%//' || echo "0")
          echo "üìä Current coverage: ${coverage_percentage}%"
          echo "COVERAGE=${coverage_percentage}" >> "$GITHUB_ENV"

          echo "‚úÖ Tests completed"

      - name: Generate coverage text report for PR comment
        shell: bash
        run: |
          echo "üìù Generating coverage text report for Dependabot PR comment..."

          # PRÁî®„ÅÆ„Ç´„Éê„É¨„ÉÉ„Ç∏„ÉÜ„Ç≠„Çπ„Éà„É¨„Éù„Éº„Éà„ÇíÁîüÊàê
          uv run coverage report > pytest-coverage.txt

          # „Éï„Ç°„Ç§„É´„ÅåÁîüÊàê„Åï„Çå„Åü„Åì„Å®„ÇíÁ¢∫Ë™ç
          if [ -f "pytest-coverage.txt" ]; then
            echo "‚úÖ pytest-coverage.txt generated successfully"
            echo "üìÑ File size: $(du -h pytest-coverage.txt | cut -f1 2>/dev/null || echo 'N/A')"
          else
            echo "‚ùå pytest-coverage.txt generation failed"
            # Dependabot„ÅÆÂ†¥Âêà„ÅØ„Ç®„É©„Éº„Åß„ÇÇÁ∂ôÁ∂ö
            echo "‚ö†Ô∏è Continuing workflow despite missing coverage text report"
            echo "No coverage data available" > pytest-coverage.txt
          fi

      - name: Verify required files for coverage comment
        shell: bash
        run: |
          echo "üîç Verifying required files for Dependabot PR..."

          # ÂøÖË¶Å„Å™„Éï„Ç°„Ç§„É´„ÅÆÁ¢∫Ë™ç„Å®‰øÆÊ≠£
          files_missing=false

          for file in "pytest-coverage.txt" "coverage.xml" "pytest.xml"; do
            if [ ! -f "$file" ]; then
              echo "‚ùå $file not found"
              files_missing=true

              # ÊúÄÂ∞èÈôê„ÅÆ„Éï„Ç°„Ç§„É´„ÇíÁîüÊàê
              case "$file" in
                "pytest-coverage.txt")
                  echo "TOTAL                         0      0   100%" > "$file"
                  ;;
                "coverage.xml")
                  echo '<?xml version="1.0" ?><coverage version="7.0"><sources><source>.</source></sources><packages></packages></coverage>' > "$file"
                  ;;
                "pytest.xml")
                  echo '<?xml version="1.0" encoding="utf-8"?><testsuites><testsuite name="pytest" errors="0" failures="0" skipped="0" tests="0" time="0.0"></testsuite></testsuites>' > "$file"
                  ;;
              esac
              echo "  üìù Generated minimal $file"
            else
              echo "‚úÖ $file found ($(du -h "$file" | cut -f1 2>/dev/null || echo 'N/A'))"
            fi
          done

          if [ "$files_missing" = true ]; then
            echo "‚ö†Ô∏è Some files were missing but have been generated with minimal content"
          else
            echo "üéâ All required files are present!"
          fi

      - name: Check coverage threshold
        shell: bash
        run: |
          coverage_value="${COVERAGE:-0}"
          if [ "$coverage_value" -lt 90 ]; then
            echo "::error::Test coverage is below 90%. Current coverage: ${coverage_value}%"
            echo "::warning::Dependabot dependency update caused coverage to drop below 90%"
            # Dependabot„ÅÆÂ†¥Âêà„ÅØË≠¶Âëä„ÅÆ„Åø„ÅßÁ∂ôÁ∂öÔºà‰æùÂ≠òÈñ¢‰øÇÊõ¥Êñ∞„Åå‰∏ªÁõÆÁöÑÔºâ
            echo "::notice::Dependabot PR: Coverage check failed but continuing workflow"
          else
            echo "‚úÖ Test coverage is above or equal to 90%. Current coverage: ${coverage_value}%"
          fi

      - name: Pytest coverage comment
        id: coverageComment
        if: always()
        uses: MishaKav/pytest-coverage-comment@v1.1.54
        with:
          pytest-coverage-path: ./pytest-coverage.txt
          pytest-xml-coverage-path: ./coverage.xml
          title: ü§ñ Dependabot Coverage Report (${{ matrix.os }} / Python ${{ matrix.python-version }})
          badge-title: coverage
          hide-badge: false
          hide-report: false
          create-new-comment: true
          hide-comment: false
          report-only-changed-files: false
          remove-link-from-badge: false
          junitxml-path: ./pytest.xml
          junitxml-title: "ü§ñ Dependabot Pytest Result Summary (os: ${{ matrix.os }} / python-version: ${{ matrix.python-version }})"
          github-token: ${{ secrets.GITHUB_TOKEN }}
        continue-on-error: true

      - name: Check test results
        if: steps.pytest.outcome == 'failure'
        run: |
          echo "::error::Tests failed on ${{ matrix.os }} with Python ${{ matrix.python-version }}"
          echo "::warning::Dependabot dependency update caused test failures"

      - name: Write job summary
        id: check_status
        shell: bash
        run: |
          # Âü∫Êú¨ÁöÑ„Å™„Çµ„Éû„É™„Éº„ÅÆ„Åø‰ΩúÊàêÔºàHTML„Çø„Ç∞„ÇíÂê´„ÇÄË§áÈõë„Å™ÂÜÖÂÆπ„ÅØÈÅø„Åë„ÇãÔºâ
          {
            echo "## ü§ñ Dependabot Test Results Summary"
            echo ""
            echo "| Metric | Value |"
            echo "|--------|-------|"
            echo "| **OS** | ${{ matrix.os }} |"
            echo "| **Python Version** | ${{ matrix.python-version }} |"
            echo "| **Coverage** | ${COVERAGE:-N/A}% |"
            echo "| **Status** | ${{ steps.pytest.outcome == 'success' && '‚úÖ Passed' || '‚ùå Failed' }} |"
            echo "| **Tool** | uv + just |"
            echo ""
            echo "### üîÑ Dependency Update Information"
            echo ""
            echo "This is an automated Dependabot PR that updates project dependencies."
            echo "The uv.lock file has been automatically updated to reflect the changes."
            echo ""
            echo "### üìà Coverage Information"
            echo ""
            if [ -n "${COVERAGE}" ] && [ "${COVERAGE}" != "N/A" ]; then
              if [ "${COVERAGE}" -ge 90 ]; then
                echo "üü¢ **Excellent coverage: ${COVERAGE}%** - Above 90% threshold"
              elif [ "${COVERAGE}" -ge 75 ]; then
                echo "üü° **Good coverage: ${COVERAGE}%** - Above 75%"
              else
                echo "üî¥ **Low coverage: ${COVERAGE}%** - Below 75%"
              fi
            else
              echo "‚ÑπÔ∏è Coverage information not available"
            fi
            echo ""
            echo "---"
            echo "**Note:** Detailed coverage report is available in the PR comments."
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Upload coverage reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: dependabot-coverage-reports-${{ matrix.os }}-${{ matrix.python-version }}
          path: |
            coverage.xml
            htmlcov/
            pytest.xml
            pytest-coverage.txt
          retention-days: 30
          if-no-files-found: warn

  check_all_tests:
    needs: test
    runs-on: ubuntu-latest
    if: github.actor == 'dependabot[bot]' && !startsWith(github.event.pull_request.title, 'Bump version')
    steps:
      - name: Check test results
        if: contains(needs.test.result, 'failure')
        run: |
          echo "::error::Some tests failed in Dependabot PR. This may indicate compatibility issues with the updated dependencies."
          echo "::error::Failed test matrices: ${{ toJson(needs.test.result) }}"
          echo "::notice::Consider reviewing the dependency update or fixing compatibility issues"
          exit 1

      - name: All tests passed
        if: success()
        run: |
          echo "‚úÖ All tests passed successfully for Dependabot dependency updates!"
          echo "ü§ñ Dependencies have been updated and tested across all OS and Python version combinations."

  send_notification:
    needs: [test, check_all_tests]
    runs-on: ubuntu-latest
    if: always() && github.actor == 'dependabot[bot]' && !startsWith(github.event.pull_request.title, 'Bump version')
    steps:
      - name: Send Discord Notification
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
          PR_TITLE: ${{ github.event.pull_request.title }}
          WORKFLOW_ACTOR: ${{ github.actor }}
        run: |
          workflow_url="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

          # „ÉÜ„Çπ„ÉàÁµêÊûú„ÅÆÂà§ÂÆö
          if [[ "${{ contains(needs.test.result, 'failure') }}" == "true" ]]; then
            status="FAILED ‚ùå"
            color=16711680  # Ëµ§Ëâ≤
            description="‚ö†Ô∏è Tests failed with dependency updates. Manual review required."
          elif [[ "${{ needs.check_all_tests.result }}" == "success" ]]; then
            status="SUCCESS ‚úÖ"
            color=65280     # Á∑ëËâ≤
            description="üéâ All tests passed! Dependencies updated successfully."
          else
            status="CANCELLED ‚ö†Ô∏è"
            color=16776960  # ÈªÑËâ≤
            description="üîÑ Workflow was cancelled or skipped."
          fi

          message="## ü§ñ Dependabot PR Check Completed

          ### üìä Workflow Information
          ‚Ä¢ **Name:** ${{ github.workflow }}
          ‚Ä¢ **Status:** ${status}
          ‚Ä¢ **Run:** [View Details]($workflow_url)
          ‚Ä¢ **PR Title:** ${PR_TITLE}
          ‚Ä¢ **Actor:** ${WORKFLOW_ACTOR}
          ‚Ä¢ **Tool:** uv + just

          ### üîÑ Dependency Update
          ‚Ä¢ **uv.lock:** Automatically updated
          ‚Ä¢ **Testing:** Cross-platform compatibility verified

          ${description}"

          timestamp="$(date -u +"%Y-%m-%dT%H:%M:%SZ")"
          json_payload=$(jq -n \
            --arg title "ü§ñ ${{ github.workflow }} - Dependabot Check Status" \
            --arg description "$message" \
            --argjson color "$color" \
            --arg timestamp "$timestamp" \
            '{
              "embeds": [
                {
                  "title": $title,
                  "description": $description,
                  "color": $color,
                  "timestamp": $timestamp,
                  "footer": {
                    "text": "ü§ñ Automated by Dependabot + uv + just"
                  }
                }
              ]
            }')

          if [ -n "$DISCORD_WEBHOOK_URL" ]; then
            curl -X POST -H "Content-Type: application/json" \
              -d "$json_payload" \
              "$DISCORD_WEBHOOK_URL"
            echo "‚úÖ Discord notification sent"
          else
            echo "‚ÑπÔ∏è Discord webhook URL not set, skipping notification"
          fi
