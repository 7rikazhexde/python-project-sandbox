name: Update Requirements after Dependabot Merge

# ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®å‡¦ç†ã®æµã‚Œ:
# 1. ãƒˆãƒªã‚¬ãƒ¼æ¡ä»¶:
#    - ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒãƒãƒ¼ã‚¸ã•ã‚ŒãŸã¨ãã€ã‹ã¤ã€Dependabot ã«ã‚ˆã‚‹ãƒãƒ¼ã‚¸ã§ã‚ã‚‹ã“ã¨
#    - æ‰‹å‹•ã§ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’ãƒˆãƒªã‚¬ãƒ¼ã™ã‚‹ã¨ã
# 2. ç’°å¢ƒã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ï¼ˆUbuntuã€Pythonã€uvï¼‰
# 3. uv.lock ãƒ•ã‚¡ã‚¤ãƒ«ã®ç¢ºèªã¨ä¾å­˜é–¢ä¿‚ã®åŒæœŸ
# 4. ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼ˆæ›´æ–°ã•ã‚ŒãŸ uv.lock ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½¿ç”¨ï¼‰
# 5. requirements.txt ã¨ requirements-dev.txt ã®ç”Ÿæˆï¼ˆpip-compileäº’æ›ï¼‰
# 6. Gist ã«ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆrequirements.txt ã¨ requirements-dev.txtï¼‰ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
# 7. requirements.txt ã¨ requirements-dev.txt ã‚’å‰Šé™¤

on:
  pull_request:
    types: [closed]
  workflow_dispatch:

jobs:
  update-requirements:
    if: github.event.pull_request.merged == true && github.event.pull_request.user.login == 'dependabot[bot]'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4.2.2
        with:
          fetch-depth: 0
          token: ${{ secrets.PAT_FOR_PUSHES }}

      - name: Install uv
        uses: astral-sh/setup-uv@v6
        with:
          version: "latest"
          enable-cache: true

      - name: Set up Python with uv
        run: |
          # Python 3.13ã‚’ä½¿ç”¨ï¼ˆå…ƒã®è¨­å®šã«åˆã‚ã›ã¦ï¼‰
          uv python install 3.13
          uv python pin 3.13

      - name: Verify uv.lock and sync dependencies
        run: |
          echo "ğŸ” Checking uv.lock file status..."
          if [ -f "uv.lock" ]; then
            echo "âœ… uv.lock file exists"
            echo "ğŸ“¦ uv.lock hash: $(sha256sum uv.lock | cut -d' ' -f1)"
          else
            echo "âš ï¸ uv.lock file not found, generating..."
            uv lock
          fi

          echo "ğŸ”„ Syncing dependencies..."
          uv sync --extra dev

      - name: Generate requirements files (pip-compatible)
        run: |
          echo "ğŸ“ Generating requirements files for pip compatibility..."

          # æœ¬ç•ªä¾å­˜é–¢ä¿‚ã®å‡ºåŠ›ï¼ˆãƒãƒƒã‚·ãƒ¥ãªã—ã€pipäº’æ›å½¢å¼ï¼‰
          {
            echo "# Generated by uv on $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
            echo "# This file is compatible with pip and other tools that expect requirements.txt format"
            echo ""
          } > requirements.txt
          uv export --format requirements-txt --no-hashes --no-dev >> requirements.txt

          # é–‹ç™ºä¾å­˜é–¢ä¿‚ã‚‚å«ã‚ãŸå‡ºåŠ›
          {
            echo "# Generated by uv on $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
            echo "# This file includes both production and development dependencies"
            echo "# Compatible with pip and other tools that expect requirements.txt format"
            echo ""
          } > requirements-dev.txt
          uv export --format requirements-txt --no-hashes >> requirements-dev.txt

          echo "âœ… Requirements files generated:"
          echo "ğŸ“„ requirements.txt ($(wc -l < requirements.txt) lines)"
          echo "ğŸ“„ requirements-dev.txt ($(wc -l < requirements-dev.txt) lines)"

          # ãƒ•ã‚¡ã‚¤ãƒ«å†…å®¹ã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
          echo "ğŸ” requirements.txt preview:"
          head -10 requirements.txt
          echo "..."
          echo ""
          echo "ğŸ” requirements-dev.txt preview:"
          head -10 requirements-dev.txt
          echo "..."

      - name: Upload requirements files to Gist
        env:
          GIST_TOKEN: ${{ secrets.PAT_FOR_PUSHES }}
        run: |
          echo "â˜ï¸ Uploading requirements files to Gist..."

          upload_to_gist() {
            local file="$1"
            local gist_id="$2"
            local json_payload

            echo "ğŸ“¤ Uploading $file to Gist ID: $gist_id"

            # jqã«fileã¨contentã‚’æ¸¡ã—ã¦JSONã‚’æ§‹ç¯‰
            json_payload=$(jq -n --arg fname "$file" --arg content "$(cat "$file")" '{"files": {($fname): {"content": $content}}}')

            if curl -X PATCH \
              -H "Authorization: token $GIST_TOKEN" \
              -H "Content-Type: application/json" \
              -d "$json_payload" \
              "https://api.github.com/gists/$gist_id"; then
              echo "âœ… Successfully uploaded $file"
            else
              echo "âŒ Failed to upload $file to Gist"
              return 1
            fi
          }

          # Gistã¸ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å®Ÿè¡Œ
          upload_to_gist "requirements.txt" "e98bb6078bc1d99f94c26f6c739724f2"
          upload_to_gist "requirements-dev.txt" "4d9c1e43c07c990b344fce63faffeef2"

          echo "ğŸ‰ All requirements files uploaded successfully!"

      - name: Verify generated files
        run: |
          echo "ğŸ” Verifying generated requirements files..."

          # åŸºæœ¬çš„ãªæ¤œè¨¼
          if [ ! -f "requirements.txt" ] || [ ! -s "requirements.txt" ]; then
            echo "âŒ requirements.txt is missing or empty"
            exit 1
          fi

          if [ ! -f "requirements-dev.txt" ] || [ ! -s "requirements-dev.txt" ]; then
            echo "âŒ requirements-dev.txt is missing or empty"
            exit 1
          fi

          # å½¢å¼ã®æ¤œè¨¼ï¼ˆåŸºæœ¬çš„ãªrequirements.txtå½¢å¼ã‹ãƒã‚§ãƒƒã‚¯ï¼‰
          if ! grep -E '^[a-zA-Z0-9_-]+[>=<]' requirements.txt > /dev/null; then
            echo "âš ï¸ requirements.txt may not contain valid package specifications"
          fi

          echo "âœ… Requirements files validation passed"

      - name: Create summary
        env:
          PR_TITLE: ${{ github.event.pull_request.title }}
        run: |
          {
            echo "## ğŸ“Š Requirements Update Summary"
            echo ""
            echo "### ğŸ”„ Updated after Dependabot merge"
            echo "- **Trigger:** ${PR_TITLE}"
            echo "- **Tool:** uv"
            echo "- **Python Version:** $(uv run python --version)"
            echo ""
            echo "### ğŸ“ Generated Files"
            echo "- **requirements.txt:** $(wc -l < requirements.txt) packages"
            echo "- **requirements-dev.txt:** $(wc -l < requirements-dev.txt) packages (including dev)"
            echo ""
            echo "### â˜ï¸ Upload Status"
            echo "- âœ… requirements.txt uploaded to Gist"
            echo "- âœ… requirements-dev.txt uploaded to Gist"
            echo ""
            echo "Files are now available for projects that require traditional requirements.txt format."
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Clean up local requirements files
        run: |
          echo "ğŸ§¹ Cleaning up local requirements files..."
          rm requirements.txt requirements-dev.txt
          echo "âœ… Local requirements files cleaned up"
