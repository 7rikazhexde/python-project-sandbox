name: Update Requirements after Dependabot Merge

on:
  pull_request:
    types: [closed]
  workflow_dispatch:

jobs:
  update-requirements:
    #if: github.event.pull_request.merged == true && github.event.pull_request.user.login == 'dependabot[bot]'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4.2.2
        with:
          fetch-depth: 0
          token: ${{ secrets.PAT_FOR_PUSHES }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: Install Poetry
        run: pip install poetry

      - name: Add plugin
        run: poetry self add poetry-plugin-export

      - name: Update lock file
        run: poetry lock

      - name: Install dependencies
        run: poetry install

      - name: Generate requirements files
        run: |
          poetry export -f requirements.txt -o requirements.txt --without-hashes
          poetry export -f requirements.txt -o requirements-dev.txt --without-hashes --with dev

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Upload requirements files to Gist
        env:
          GIST_TOKEN: ${{ secrets.PAT_FOR_PUSHES }}
        run: |
          upload_to_gist() {
            local file="$1"
            local gist_id="$2"
            # 変数の宣言と代入を分離
            local json_payload
            json_payload=$(jq -n --arg content "$(cat "$file")" '{"files": {($file): {"content": $content}}}' "$file")
            curl -X PATCH \
              -H "Authorization: token $GIST_TOKEN" \
              -H "Content-Type: application/json" \
              -d "$json_payload" \
              "https://api.github.com/gists/$gist_id" || echo "Failed to upload $file to Gist"
          }
          upload_to_gist "requirements.txt" "e98bb6078bc1d99f94c26f6c739724f2"
          upload_to_gist "requirements-dev.txt" "4d9c1e43c07c990b344fce63faffeef2"

      #- name: Commit and push changes to main repository
      #  run: |
      #    git config --local user.email "33836132+github-actions[bot]@users.noreply.github.com"
      #    git config --local user.name "github-actions[bot]"
      #    git add pyproject.toml poetry.lock
      #    git commit -m ":wrench: Update lock file after dependency update [skip ci]" || echo "No changes to commit"
      #    git push

      - name: Clean up local requirements files
        run: |
          rm requirements.txt requirements-dev.txt
